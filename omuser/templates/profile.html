{% extends 'base.html' %}
{% load static %}
{% load i18n %} 
{% block content %}
<!-- 
	profile.html profilePage
	author : Pei lin
-->
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <h1>
        {% trans '使用者管理' %}
        <small id="h1_small"></small>
      </h1>
      <ol class="breadcrumb">
        <li><a href="{% url 'homePage' %}"><i class="fa fa-dashboard"></i>{% trans '首頁' %}</a></li>
        <li><a href="#">{% trans '人員管理' %}</a></li>
        <li id="user_management"><a href="/accounts/page/user-management/" id="user_management">{% trans '使用者管理' %}</a></li>
        <li><a href="/accounts/page/profile/{{username}}/">{% trans '使用者設定' %}</a></li>
      </ol>
    </section>

    <!-- Main content -->
    <section class="content">
      <div class="row">
       <!-- column -->
        <div class="col-md-12">
          <div class="nav-tabs-custom">
            <ul class="nav nav-tabs">
              <li class="active"><a href="#p1" data-toggle="tab">{% trans '資料設定' %}</a></li>
              <li><a href="#p2" data-toggle="tab" data-name="p2" style="display:None">{% trans '組織設定' %}</a></li>
			  <li><a href="#p3" data-toggle="tab" data-name="p3" style="display:None">{% trans '角色設定' %}</a></li>
            </ul>
            <div class="tab-content">
              <div class="tab-pane active" id="p1">
			  	<!-- form start -->
				<form id="omformProfile" onsubmit="omflowSubmit(); return false;" role="form" autocomplete="off" >
				{% csrf_token %}		
				<div class="box box-default">	
				  <div class="box-header with-border">
				  	<button type="submit" class="btn btn-default" style="margin:1px 0px;display:None;" id="store_button" style="display:None"><i class="fa fa-save"></i> {% trans '儲存' %}</button>
				  </div>			
				  <div class="box-body">
					<div class="row">
					  <div class="col-md-4">
						<div class="form-group has-warning">
						  <label>{% trans '帳號' %}</label>
						  <div class="input-group">	
							<span class="input-group-addon"><i class="glyphicon glyphicon-user"></i></span>
							<form><input type="text" name="username" id="username" class="form-control" placeholder="{%trans '帳號'%}" required="true"/></form>					
						  </div>
						</div>
						<!-- /.form-group -->	
						<div class="form-group has-warning">
						  <label>{% trans '密碼'%}</label>      
						  <div class="input-group">
							<span class="input-group-addon"><i class="glyphicon glyphicon-lock"></i></span>
							<form><input type="password" name="token" id="token" class="form-control" placeholder="{% trans '密碼'%}" required="true" {% if username != 'newuser' %} readonly="true" {% endif %} autocomplete="off"/></form>				
						  </div>
						</div>
						<!-- /.form-group -->	
						<div class="form-group has-warning">
						  <label>{% trans '電子郵件地址'%}</label>      					
						  <div class="input-group">
							<span class="input-group-addon"><i class="glyphicon glyphicon-envelope"></i></span>
							<input type="email" name="email_@" id="email" class="form-control" placeholder="{% trans '電子郵件地址'%}"  required="true"/>
						  </div>
						</div>
						<!-- /.form-group -->					
						<div class="form-group">
						  <label>{% trans '性別'%}</label>
						  <div class="input-group">
							<span class="input-group-addon"><i class="glyphicon glyphicon-user"></i></span>														
							<select name="gender" class="form-control">
							  <option value=""></option>
							  <option value="male">{% trans '男'%}</option>
							  <option value="female">{% trans '女'%}</option>	                  		
							</select>
						  </div>
						</div>
						<!-- /.form-group -->	
						<div class="form-group">
						  <label>{% trans '生日' %}</label>
						  <div class="input-group date" >
							<span class="input-group-addon"><i class="fa fa-calendar"></i></span>
							<input type="text" name="birthday_%Y" id="birthday" class="form-control" data-provide="datepicker" data-date-format="yyyy-mm-dd" data-date-language="zh-TW" data-date-enable-On-Readonly="false">
						  </div>
						</div>
						<!-- /.form-group -->	
					  </div>
					  <!-- /.col -->
					  <div class="col-md-4">
					  	<div class="form-group has-warning">
						  <label>{% trans '名稱'%}</label>
						  <div class="input-group">
							<span class="input-group-addon"><i class="fa fa-user"></i></span>
							<input type="text" name="nick_name" id="nick_name" class="form-control" placeholder="{% trans '名稱'%}" required="true"/>					
						  </div>
						</div>
						<!-- /.form-group -->	
						<div class="form-group">
						  <label>{% trans '公司'%}</label>
						  <div class="input-group">
							<span class="input-group-addon"><i class="fa fa-building"></i></span>
							<input type="text" name="company" id="company" class="form-control" placeholder="{% trans '公司'%}"/>					
						  </div>
						</div>
						<!-- /.form-group -->	
						<div class="form-group">
						  <label>{% trans '部門'%}</label>
						  <div class="input-group">
							<span class="input-group-addon"><i class="fa fa-briefcase"></i></span>
							<input type="text" name="department" id="department" class="form-control" placeholder="{% trans '部門'%}"/>					
						  </div>
						</div>
						<!-- /.form-group -->	
						<div class="form-group">
						  <label>{% trans '電話'%}</label>
						  <div class="input-group">
							<span class="input-group-addon"><i class="glyphicon glyphicon-earphone"></i></span>
							<input type="text" name="phone1" id="phone1" class="form-control" placeholder="{% trans '電話'%}"/>
						  </div>
						</div>
						<!-- /.form-group -->	
						<div class="form-group">
						  <label>{% trans '手機'%}</label>
						  <div class="input-group">    
							<span class="input-group-addon"><i class="glyphicon glyphicon-phone"></i></span>  
							<input type="text" name="phone2" id="phone2" class="form-control" placeholder="{% trans '手機'%}"/>
						  </div>
						</div>
						<!-- /.form-group -->
					  </div>
					  <!-- /.col -->
					  <div class="col-md-4">
					  	<div class="form-group">
						  <label>{% trans '組織'%}</label>
						  <div class="input-group">
							<span class="input-group-addon"><i class="fa fa-users"></i></span>
							<select name="groups" id="groups" class="form-control" multiple disabled></select>
						  </div>
						</div>
						<!-- /.form-group -->
						<div class="form-group">
						  <label>{% trans '角色'%}</label>
						  <div class="input-group">
							<span class="input-group-addon"><i class="fa fa-shield"></i></span>
							<select name="role" id="role" class="form-control" multiple disabled></select>					
						  </div>
						</div>
						<!-- /.form-group -->
						<div class="form-group">
						  <label>{% trans '通知更新頻率'%}</label>
                    	  <input id="refresh_rate" type="text" name="refresh_rate_$" class="js-range-slider">
					  	</div>
					  	<!-- /.form-group -->
					  </div>
					  <!-- /.col -->
					</div>
					<!-- /.row -->
				  </div>
				  <!-- /.box-body -->
				  <div class="box-footer">
				    <div class="row">
					  <div class="col-md-4">
					    <button type="submit" title="儲存變更" class="btn btn-primary btn-block btn-flat" id="store_button" style="display:None">{% trans '儲存'%}</button>
					  </div>
					  <!-- /.col -->
					</div>
					<!-- /.row -->
				  </div>
				  <!-- /.box-footer -->
				  </div>
				</form> 
  			  </div>
  			  <!-- /.tab-pane p1 -->
  			  {% if username != "newuser" %}
			  <div class="tab-pane " id="p2">
				<div class="row">
				  <div class="col-md-12">
				  <div class="box box-default">
				  	<div class="box-header with-border">
				  	  <button type="button" class="btn btn-default" onclick="store_group()" style="margin:1px 0px;display:None;" id="store_group_button"><i class="fa fa-save"></i> {% trans '儲存' %}</button>
				  	  <button type="button" class="btn btn-default" id="expander" style="margin:1px 0px;"><i class="fa fa-chevron-down"></i> {% trans '展開 ' %}</button>
					  <button type="button" class="btn btn-default" id="collapser" style="margin:1px 0px;"><i class="fa fa-chevron-up"></i> {% trans '收合 ' %}</button>
					  <button type="button" title="{% trans '篩選組織' %}" class="btn btn-default " onclick="filter_group()" id="filter_group" style="margin:1px 0px;"><i class="fa fa-filter"></i>{% trans ' 篩選' %}</button>
					  <button type="button" title="{% trans '清除篩選條件' %}" class="btn btn-default " onclick="filter_default()" style="margin:1px 0px;"><i class="fa fa-undo"></i>{% trans ' 還原' %}</button>
					</div>
  					<div class="box-body">
					  <div class="row">
  						<div class="col-md-12">
					  	  <table id="group_table" class="table no-margin">
						    <col width="5%">
						    <col width="74%">
						    <thead>
						      <tr>
						      	<th></th>
						      	<th>{% trans '所有組織列表' %}</th>
						      </tr>
						    </thead>
						    <tbody id="group_table_body">
						    </tbody>
						  </table>
					    </div>
					    <!-- /.col -->
					  </div>
					  <!-- /.row -->
				    </div>
				    <!-- /.bos-body -->
				    </div>	
				  </div>
				  <!-- /.col -->
				</div>
			    <!-- /.row -->
		  	  </div>
		  	  <!-- /.tab-pane p2 -->
			  <div class="tab-pane " id="p3">
			  	<div class="row">
				  <div class="col-md-12">
				  	<div class="box box-default">
				  	  <div class="box-header with-border">
				  	  	<button type="button" class="btn btn-default" onclick="store_role()" style="margin:1px 0px;display:None;" id="store_role_button"><i class="fa fa-save"></i> {% trans '儲存' %}</button>
				  	  	<button type="button" title="{% trans '篩選權限角色' %}" class="btn btn-default " onclick="filter_role()" id="filter_role" style="margin:1px 0px;"><i class="fa fa-filter"></i>{% trans ' 篩選' %}</button>
				  	  	<button type="button" title="{% trans '清除篩選條件' %}" class="btn btn-default " onclick="filter_default()" style="margin:1px 0px;"><i class="fa fa-undo"></i>{% trans ' 還原' %}</button>
					  </div>
  					  <div class="box-body">
					  	<div class="row">
  						  <div class="col-md-12">
					  	  	<table id="role_table" class="table no-margin">
						      <col width="5%">
						      <col width="40%">
						      <col width="45%">
						      <thead>
						      	<tr>
						      	  <th></th>
						      	  <th>{% trans '所有角色列表' %}</th>
						      	  <th>{% trans '說明' %}</th>
						      	</tr>
						      </thead>
						      <tbody id="role_table_body">
						      </tbody>
						  	</table>
					      </div>
					      <!-- /.col -->
					  	</div>
					  	<!-- /.row -->
				      </div>
				      <!-- /.box-body -->	
				    </div>
				  </div>
				  <!-- /.col -->
				</div>
			    <!-- /.row -->
			  </div>
			  <!-- /.tab-pane p3 -->
			  {% endif %}
            </div>
            <!-- /.tab-content -->
          </div>
          <!-- /.nav-tabs-custom -->        
        </div>
        <!--/.col -->
      </div>
      <!-- /.row -->
    </section>
    <!-- /.content -->
<script>
{% if username == "newuser"  %}		//新增使用者所需功能
	{% if perms.omuser.OmUser_Add %}
	$(function(){
		$('#refresh_rate').ionRangeSlider({
			min     : 5,
		  	max     : 120,
			step    : 5,
			from	: 5,
			type    : 'single',
			postfix : ' {% trans "秒"%}',
			prettify: false,
			grid	: true,
			grid_num: 6,
	    });
	    $('#store_button').show();
	});
	function omflowSubmit()		//addUserAjax 送出 omformProfile 新增使用者 
	{	
			omflowAjax('omformProfile','{% url 'addUserAjax' %}',actions);
	}
	function actions(data)		
	{
		if(data.status == 200)
		{
			omflowAlert('green', data.message);
			$('#modal_green button:eq(1)').off('click').on('click',function(){
				window.location.href='/accounts/page/user-management';
				$('#modal_green').modal('hide');
			});
		}	
		else
		{
			omflowAlert('blue', data.message, check_actions, data);
		}
	} 
	function check_actions(data)
	{
		$.each(data.result.result, function(index, value){
			$('input[name="'+value+'"]').css("border-color","rgb(253, 13, 77)")
		});
	}
	{% endif %}
{% else %}		//編輯使用者個人資料所需功能
var username="";
var grouplist=[];
var rolelist=[];
$(function (){
	var user_edit = location.pathname.split('/');
	var user_refresh = '';
	var postdata = {  csrfmiddlewaretoken: '{{ csrf_token }}' , username_click: user_edit[4]};
	$.ajax({
		url: "{% url 'loadUserAjax' %}",
		type: 'post',
		data: postdata,
		success: function (data) {
			if (data.status==200){
				username = data.result.user.username;
				datagrouplist = data.result.group_list;
				$.each(datagrouplist, function(index, value){
					if(value.functional_flag==false)
					{
						grouplist.push(value);
					}
					else
					{
						rolelist.push(value);
					}
				});
				var usergroup = data.result.user_group_list;
				var useradgroup = data.result.user_adgroup_list;
				var userrole = data.result.user_role_list;
				var ad_flag = data.result.user.ad_flag ;
				$('#username').val(data.result.user.username);
				$('#token').val(data.result.user.password);
				$('#email').val(data.result.user.email);
				$('#nick_name').val(data.result.user.nick_name);
				$('#company').val(data.result.user.company);
				$('#department').val(data.result.user.department);
				$('select option[value="'+data.result.user.gender+'"]').prop('selected','selected');
				$('#phone1').val(data.result.user.phone1);
				$('#phone2').val(data.result.user.phone2);
				$('#birthday').val(data.result.user.birthday);
				$('#h1_small').text(data.result.user.username);
				$('#username').prop('readonly',true);
				user_refresh = data.result.user.frequency;
				if ( user_edit[4] != '{{user.username}}'){
					$('#token').prop('readonly',false);
				};
				$.each(usergroup, function(index, value){
					$('#groups').append('<option>'+value+'</option>');
				});
				$.each(useradgroup, function(index, value){
					$('#groups').append('<option>'+value+'  (AD)</option>');
				});	
				$.each(userrole, function(index, value){
					$('#role').append('<option>'+value+'</option>');
				});	
				$.each(grouplist, function(index, value){
					if (value.parent_group==null && value.functional_flag==false){
						$('#group_table_body').prepend( '<tr data-node-id="'+value.id+'" id="group_id_'+value.id+'">'+
							'<td><input type="checkbox" class="icheckbox_minimal-blue" data-name="checkbox" id="'+value.name+'" value="'+value.name+'"><label for="'+value.name+'"></label></td><td>&nbsp;&nbsp;'+value.name+'</td>'+
							'</tr>')
					}else if(value.functional_flag==false){
						$("#group_id_"+value.parent_group).after( '<tr data-node-id="'+value.id+'" data-node-pid="'+value.parent_group+'" id="group_id_'+value.id+'">'+
							'<td><input type="checkbox" class="icheckbox_minimal-blue" data-name="checkbox" id="'+value.name+'" value="'+value.name+'"><label for="'+value.name+'"></label></td><td>&nbsp;&nbsp;'+value.name+'</td>'+
							'</tr>')
					}	
				});
				$.each(rolelist, function(index, value){
					$('#role_table_body').prepend( '<tr data-node-id="'+value.id+'" id="group_id_'+value.id+'">'+
						'<td><input type="checkbox" class="icheckbox_minimal-blue" data-name="checkbox" id="'+value.name+'" value="'+value.name+'"><label for="'+value.name+'"></label></td><td>&nbsp;&nbsp;'+value.name+'</td><td>'+value.description+'</td></tr>')
				});
				$.each(usergroup, function(index,value){
					$('#'+value).prop("checked", true);
				});
				$.each(userrole, function(index,value){
					$('#'+value).prop("checked", true);
				});
				$('#group_table').simpleTreeTable({
				    expander: $('#expander'),
				    collapser: $('#collapser'),
				    iconPosition: ':eq(3)',
				    opened: ''
				});
				$('ul.sidebar-menu ul.treeview-menu > li > a[href="/accounts/page/user-management/"]').parentsUntil(".sidebar-menu > .treeview-menu").siblings().removeClass('active menu-open').end().addClass('active menu-open');
				check_permission(ad_flag);
			}
			else
			{actions(data)}
		},
		error: function(req, status, err) {
			$('#modal_error').modal('show');
			console.log('Something went wrong', status, err);
		},
		complete: function(){
			{% if perms.omuser.OmGroup_Add %}
		  	$('.select2').select2();
		  	{% endif %}
		  	$('#refresh_rate').ionRangeSlider({
				min     : 5,
			  	max     : 60,
				step    : 5,
				from	: user_refresh,
				type    : 'single',
				postfix : ' {% trans "秒"%}',
				prettify: false,
				grid	: true,
				grid_num: 11,
		    });
		}
	});
});
function check_permission(ad_flag)
{
	{% if username != "newuser" %}
		{% if perms.omuser.OmUser_View and not perms.omuser.OmUser_Modify and not username == request.user.username %}
			$('form input').attr('readonly','true');
			$('select').attr('disabled', 'disabled');
		{% endif %}
		{#如果有OmUser_Modify權限，將可儲存User資料#}
		{% if username == user.username or perms.omuser.OmUser_Modify %}
			$('#store_button').show();
		{% endif %}
		{#如果有OmGroup_View權限，將顯示組織設定、角色設定頁面#}
		{% if perms.omuser.OmGroup_View %}
			$('a[data-name="p2"]').show();
			$('a[data-name="p3"]').show();
		{% endif %}
		{#如果有OmGroup_Modify權限，將顯示選取及儲存#}	
		{% if perms.omuser.OmGroup_Modify %}
			$('#store_group_button').show();
			$('#store_role_button').show();
		{% else %}
			$('input[data-name="checkbox"]').attr('disabled','disabled');
		{% endif %}
	{% endif %}
	if (ad_flag)
	{
		$('#token').prop('readonly',true).prop('required',false);
	}
}
function omflowSubmit()
{	
		omflowAjax('omformProfile','{% url 'updateUserAjax' %}',actions);
		Swal.fire({
		  title: '處理中...',
		  toast: true,
		  position: 'bottom-start',
		  showConfirmButton: false,
		});
		Swal.showLoading();
}
function actions(data)
{		
	Swal.close();
	if(data.status == 200)
	{
		Swal.fire({
      	  icon : 'success',
      	  title: data.message,
      	  toast: true,
	  	  position: 'bottom-start',
	  	  showConfirmButton: false,
      	  timer: 2000,
	    });
	}	
	else if (data.status == 404)
	{
		omflowAlert('yellow', data.message, cactions, data);
	}
	else if (data.status == 500)
	{
		omflowAlert('blue', data.message);
	}
	else if (data.status == 403)
	{
		omflowAlert('red', data.message);
	}
}

function cactions(data)
{
	$.each(data.result.result, function(index, value){
		$('input[name="'+value+'"]').css("border-color","rgb(253, 13, 77)")
	});
}

	function filter_group()		
	{
		omflowFilter(['filter_search']);
		$('#modal-default-filter button:eq(2)').off("click").on("click",function(){
			var searchkey = $('#modal-default-filter #search').val();
			if (searchkey!=null && searchkey.length!=0)
			{
				$('tr').hide();
				$.each($('tr:contains("'+searchkey+'")'),function(){
					var thisDom = $(this).show();
					var pid =  $(this).data("node-pid");
					if(typeof(pid)!="undefined" && pid.length!="0"){
						showParent(pid);
					}
				});
				//
				function showParent(pid){
					$('tr[data-node-id="'+pid+'"]').show();
					var thisPid = $('tr[data-node-id="'+pid+'"]').data("node-pid");
					if(typeof(thisPid)!="undefined" && thisPid.length!="0"){
						showParent(thisPid);
					}
				}
			}
			else
			{
				$('tr').show();
				$('#group_table').data('simple-tree-table').collapse();
			}
			$('#modal-default-filter').modal('hide');
		});
	}
	
	function filter_role()		
	{
		omflowFilter(['filter_search']);
		$('#modal-default-filter button:eq(2)').off("click").on("click",function(){
			var searchkey = $.trim($('#modal-default-filter #search').val());
			if (searchkey)
			{
				$('tr').hide();
				$('tr:contains("'+searchkey+'")').show();
			}
			else
			{
				$('tr').show();
			}			
			$('#modal-default-filter').modal('hide');
		});
	}
	
	function filter_default()
	{
		$('tr').show();
	}
	
	function store_group()
	{	
		var this_check = [];
		$.each($('#group_table input:checkbox:checked'), function(){
			this_check.push($(this).val());
		});
		var postbody = {'csrfmiddlewaretoken':"{{ csrf_token}}", 'username': username, 'group_list': this_check, 'functional_flag_%B':'False'} 
		omflowJsonAjax(postbody, "{% url 'groupUserAjax'%}", actions);
	}
	
	function store_role()
	{
		var this_check = [];
		$.each($('#role_table input:checkbox:checked'), function(){
			this_check.push($(this).val());
		});
		var postbody = {'csrfmiddlewaretoken':"{{ csrf_token}}", 'username': username, 'group_list': this_check, 'functional_flag_%B': 'True'} 
		omflowJsonAjax(postbody, "{% url 'groupUserAjax'%}", actions);
		
	}
{% endif %}
</script>
{% endblock %}