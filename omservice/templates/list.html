{% extends 'base.html' %}
{% load static %}
{% load i18n %} 
{% block content %}
    <script src="{% static 'plugins/autosize/autosize.min.js'%}"></script>
    <section class="content-header">
      <!-- Content Header (Page header) -->
        <h1>{% trans '服務請求'%}&nbsp;
        </h1>
      	<ol class="breadcrumb">
        	<li><a data-idx="-1" href="/"><i class="fa fa-dashboard"></i>{% trans '首頁'%}</a></li>
        	<li><a data-idx="0" style="cursor:pointer;"onclick="setPath(0)">{% trans '服務請求'%}</a></li>
      	</ol>
      <!--<ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> 首頁</a></li>
      </ol>-->
    </section>
    <!-- Main content -->
    <section class="content" style="padding-bottom:0px;">
      <div class="row">
      	<div class="col-xs-12">
      	  <div class="box box-primary">
      	    <div class="box-header with-border" >
      	      {% if perms.omservice.OmServiceDesign_Manage %}
      	      <div class="pull-left">
              	<button type="button" class="btn btn-default" id="edit-mode_save" onclick="ServiceRoot_save()" style="display:none;"><i class="fa fa-save"></i> {% trans '儲存'%}</button>
				<button type="button" class="btn btn-default" id="edit-mode_cancel" onclick="ServiceRoot_cancel()" style="display:none;"><i class="fa fa-undo"></i> {% trans '取消'%}</button>
		        <button type="button" class="btn btn-default" id="read-mode_edit" onclick="ServiceRoot_edit()" style="display:none;"><i class="fa fa-pencil-square-o"></i> {% trans '編輯'%}</button>
		      </div>
              <div class="pull-right" >
			    <button type="button" class="btn btn-default" id="edit-mode_addS" onclick="add_service()" style="margin:1px 0px;display:none;"><i class="fa fa-plus"></i> {% trans '建立服務'%}</button>
			    <button type="button" class="btn btn-default" id="edit-mode_addF" onclick="add_object('folder')" style="display:none;"><i class="fas fa-folder-plus"></i> {% trans '建立資料夾'%}</button>
			    &nbsp;&nbsp;
			    <button type="button" class="btn btn-default" id="edit-mode_Trans" onclick="app_translate()" style="display:none;"><i class="fas fa-language"></i> {% trans '語言'%}</button>
			    <button type="button" class="btn btn-default" id="edit-mode_Import" onclick="$('#file2').click()" style="display:none;"><i class="fa fa-download"></i> {% trans '匯入'%}</button>
                <input type="file" id="file2" onchange="service_inputFile(this.files)" style="display:none;"/>
			    <button type="button" class="btn btn-default" id="edit-mode_Export" onclick="flowapp_output()" style="display:none;"><i class="fa fa-upload"></i> {% trans '匯出'%}</button>
			  </div>
			  {% endif%}
      	    </div>
      	    <!-- box-header -->
      	    <div class="box-body">
	      	    <div class="input-group SearchBar">
	                <input type="text" class="form-control" id="service_keyword" >
                    <span class="input-group-btn">
                      <button type="button" onclick="Service_Search()" class="btn btn-info btn-flat">{% trans '搜尋'%}</button>
                    </span>
	            </div>
	            <div class="col-md-2" style="padding: 0px 0px 0px 5px;">
	            	<ul id="ServiceList"></ul>
	            </div>
	      	    <div class="col-md-10" style="padding: 0px 30px 0px 0px;">
	      	    	<div id="ServiceRoot" class="omflow-box-body" style="overflow:auto;padding-top:5px;"></div>
				</div>
			</div>
			<!-- box-body -->
      	  </div>
      	  <!-- box -->
      	</div>
      	<!-- col -->
      </div>
      <!-- row -->
      {% get_language_info_list for LANGUAGES  as LANGUAGES %}
      {% get_current_language as LANGUAGE_CODE %}
      <div class="modal fade" id="modal-app_translate" data-backdrop="static">
		<div class="modal-dialog">
		  <div class="modal-content">
		    <div class="modal-header">
			  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
			    <span aria-hidden="true">&times;</span></button>
	          <h4 class="modal-title"><i class="fas fa-language"></i>&nbsp;&nbsp;{% trans '語言翻譯'%}</h4>
		    </div>
		    <div class="modal-body">
		  	  <div class="form-group">
			    <label>{% trans '選擇語系'%}</label>
		  	    <select class="form-control" id="language-select">{% for lang in LANGUAGES%}<option value="{{lang.code}}">{{lang.name_translated}} ({{lang.code}}) </option>{% endfor %}</select>
		  	  </div>
		  	  <button type="button" class="btn btn-default" onclick="$('#file').click()" style="margin:1px 0px;"><i class="fa fa-download"></i> {% trans '匯入'%}</button>
		  	  <input type="file" id="file" onchange="translate_input(this.files)" style="display:none;"/>
		  	  <button type="button" class="btn btn-default" onclick="translate_output()" style="margin:1px 0px;"><i class="fa fa-upload"></i> {% trans '匯出'%}</button>
		    </div>
		    <div class="modal-footer">
			  <button type="button" class="btn btn-default" data-dismiss="modal">{% trans '關閉'%}</button>
		    </div>
		  </div>
	    </div><!-- /.modal-content -->
	  </div>
    <!-- /.modal -->
    
    <!-- .modal -->
    <div class="modal fade" id="modal-service_input" data-backdrop="static">
	  <div class="modal-dialog">
		<div class="modal-content">
		  <div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-label="Close">
			  <span aria-hidden="true">&times;</span></button>
			<h4 class="modal-title"><i class="fa fa-download"></i>&nbsp;&nbsp;{%trans '重新匯入服務'%}</h4>
		  </div>
		  <div class="modal-body">
		  	<ul class="mailbox-attachments clearfix" id="service_input_name">
            </ul>
		  </div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-default pull-left" data-dismiss="modal">{%trans '取消'%}</button>
			<button type="button" class="btn btn-primary" data-dismiss="modal" onclick="service_inputSave()">{%trans '確定'%}</button>
		  </div>
		</div>
	  </div><!-- /.modal-content -->
	</div>
	<!-- /.modal -->
	
	<!-- .modal -->
	<div class="modal fade" id="formcontent_subquery_table_modal" style="z-index:1051;">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title"></h4>
				</div>
				<div class="modal-body">
					<table class="table table-bordered table-striped table-hover" id="formcontent_subquery_table_modal_datatable" width="100%">
			  	   	  	<thead><tr></tr></thead>
			  	  	   	<tbody></tbody>
			  	    </table>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default pull-left" id="formcontent_subquery_table_modal_close">{%trans '取消'%}</button>
					<button type="button" class="btn btn-primary" id="formcontent_subquery_table_modal_submit">{%trans '確定'%}</button>
				</div>
			</div>
		</div><!-- /.modal-content -->
	</div>
	<!-- /.modal -->
	
	<!-- 資料夾設定 -->
	<div class="modal fade" id="modal-folder-config" name="">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
      	      <span aria-hidden="true">&times;</span>
      	    </button>
            <h4 class="modal-title"><i class="fa fa-gear"></i>&nbsp;&nbsp;{% trans '內容設定'%}</h4>
          </div>
          <div class="modal-body">
          	<table style="width:100%;"></table>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default pull-left" data-dismiss="modal">{% trans '取消'%}</button>
            <button type="button" class="btn btn-primary" onclick="Grid_submit()">{% trans '確定'%}</button>
          </div>
        </div>
	  </div>
	</div>
    </section>

	<script>
    /**
	 * dashboard
	 * author:Arthur Wang
	 */
	//18N_translation
    var const_home = "{% trans '首頁'%}",
    	const_all = "{% trans '全部'%}",
    	const_service = "{% trans '服務請求'%}",
    	const_folder = "{% trans '資料夾'%}",
    	const_hr = "{% trans '分隔線'%}",
    	const_color = "{% trans '顏色'%}",
    	const_title = "{% trans '標題'%}",
    	const_tip = "{% trans '說明'%}",
    	const_icon = "{% trans '圖示'%}",
    	const_form = "{% trans '選擇表單'%}",
    	const_first_step = "{% trans '第一步驟'%}",
    	const_new_step = "{% trans '新步驟'%}",
    	const_column = "{% trans '選擇欄位'%}",
    	const_service_target = "{% trans '服務對象'%}",
		const_color_blue = "{% trans '藍'%}",
		const_color_sky = "{% trans '青'%}",
		const_color_green = "{% trans '綠'%}",
		const_color_yellow = "{% trans '黃'%}",
		const_color_red = "{% trans '紅'%}",
		const_color_purple = "{% trans '紫'%}",
		const_color_gray = "{% trans '灰'%}",
		const_color_dark_gray = "{% trans '深灰'%}",
		const_color_cream = "{% trans '米黃'%}",
		const_fill_form = "{% trans '填寫表單'%}",
		const_all_people = "{% trans '所有人'%}",
		const_lack_require = "{% trans '缺少必填欄位。'%}",
		const_upload_file = "{% trans '上傳檔案'%}",
		const_require = "{% trans '必填'%}",
		const_off_shelf = "{% trans '下架'%}",
		const_choice_file = "{% trans '選擇檔案'%}",
		const_remind_tip = "{% trans '輸入提示說明'%}",
		const_none_user = "{% trans '不預選受派人'%}",
		const_none_column = "{% trans '已新增所有欄位'%}",
		const_delete_service = "{% trans '移除服務' %}",
		const_deleting_1 = "{% trans '即將移除「 '%}",
		const_deleting_2 = "{% trans ' 」，是否繼續？ '%}";
    
    //global_parameters
	var box_container = 0; //action container id
	var box_object = box_object();
	var form_object = null;
	var form_list = null;
	var column_object = {};
	var old_box_object = "";
	var textFile = null; //設計檔案
	var read_mode = true;
	var csrfmiddlewaretoken="{{ csrf_token }}";
	var timer_list = {}; //重複更新需取消前次計時
	var chart_list = {}; //更新時須取消原圖
	var input_file = '';
	var lan_package = null;
	var table = null; //子查詢專用
	var data_tmp; //子查詢專用   
	var data_len; //子查詢專用   
	var data_page; //子查詢專用   
	var data_drawn = false; //子查詢專用   
	var color_set = [
		{name:const_color_blue,color:"#337ab7"},
		{name:const_color_sky,color:"#00c0ef"},
		{name:const_color_green,color:"#00a65a"},
		{name:const_color_yellow,color:"#f39c12"},
		{name:const_color_red,color:"#dd4b39"},
		{name:const_color_purple,color:"#9d44a5"},
		{name:const_color_gray,color:"#d2d6de"},
		{name:const_color_dark_gray,color:"#ABABAB"},
		{name:const_color_cream,color:"#FFEE99"},
		];
	
	var config_set = {
		setColor:
            '<div class="form-group">'+
                '<label class="text-light-blue">'+const_color+'</label>'+
                '<div></div>'+
                '<input name="showColor" style="display:inline-block;width:20%;top:-1px;position:relative;" class="form-control" readOnly></input>'+
                '<select style="display:inline-block;width:80%;" name="setColor" class="form-control select2" >'+
                    '<option data-color="'+color_set[0].color+'" value="bg-blue">'+color_set[0].name+'</option>'+
                    '<option data-color="'+color_set[1].color+'" value="bg-aqua">'+color_set[1].name+'</option>'+
                    '<option data-color="'+color_set[2].color+'" value="bg-green">'+color_set[2].name+'</option>'+
                    '<option data-color="'+color_set[3].color+'" value="bg-yellow">'+color_set[3].name+'</option>'+
                    '<option data-color="'+color_set[4].color+'" value="bg-red">'+color_set[4].name+'</option>'+
                    '<option data-color="'+color_set[5].color+'" value="color-purple">'+color_set[5].name+'</option>'+
                '</select>'+
            '</div>',
		setChartColor:
            '<div class="form-group">'+
                '<label class="text-light-blue">'+const_color+'</label>'+
                '<div></div>'+
                '<input name="showColor" style="display:inline-block;width:20%;top:-1px;position:relative;" class="form-control" readOnly></input>'+
                '<select style="display:inline-block;width:80%;" name="setColor" class="form-control select2" >'+
                    '<option data-color="'+color_set[0].color+'" value="0">'+color_set[0].name+'</option>'+
                    '<option data-color="'+color_set[1].color+'" value="1">'+color_set[1].name+'</option>'+
                    '<option data-color="'+color_set[2].color+'" value="2">'+color_set[2].name+'</option>'+
                    '<option data-color="'+color_set[3].color+'" value="3">'+color_set[3].name+'</option>'+
                    '<option data-color="'+color_set[4].color+'" value="4">'+color_set[4].name+'</option>'+
                    '<option data-color="'+color_set[5].color+'" value="5">'+color_set[5].name+'</option>'+
                    '<option data-color="'+color_set[6].color+'" value="6">'+color_set[6].name+'</option>'+
                    '<option data-color="'+color_set[7].color+'" value="7">'+color_set[7].name+'</option>'+
                '</select>'+
            '</div>',
		setBoxColor:
            '<div class="form-group">'+
                '<label class="text-light-blue">'+const_color+'</label>'+
                '<div></div>'+
                '<input name="showColor" style="display:inline-block;width:20%;top:-1px;position:relative;" class="form-control" readOnly></input>'+
                '<select style="display:inline-block;width:80%;" name="setColor" class="form-control select2" >'+
                    '<option data-color="'+color_set[6].color+'" value="box-default">'+color_set[6].name+'</option>'+
                    '<option data-color="'+color_set[0].color+'" value="box-primary">'+color_set[0].name+'</option>'+
                    '<option data-color="'+color_set[1].color+'" value="box-info">'+color_set[1].name+'</option>'+
                    '<option data-color="'+color_set[2].color+'" value="box-success">'+color_set[2].name+'</option>'+
                    '<option data-color="'+color_set[3].color+'" value="box-warning">'+color_set[3].name+'</option>'+
                    '<option data-color="'+color_set[4].color+'" value="box-danger">'+color_set[4].name+'</option>'+
                '</select>'+
            '</div>',
        setBarColor:
            '<div class="form-group">'+
                '<label class="text-light-blue">'+const_color+'</label>'+
                '<div></div>'+
                '<input name="showColor" style="display:inline-block;width:20%;top:-1px;position:relative;" class="form-control" readOnly></input>'+
                '<select name="setColor" style="display:inline-block;width:80%;" class="form-control select2" >'+
                    '<option data-color="'+color_set[0].color+'" value="progress-bar-blue">'+color_set[0].name+'</option>'+
                    '<option data-color="'+color_set[1].color+'" value="progress-bar-aqua">'+color_set[1].name+'</option>'+
                    '<option data-color="'+color_set[2].color+'" value="progress-bar-green">'+color_set[2].name+'</option>'+
                    '<option data-color="'+color_set[3].color+'" value="progress-bar-yellow">'+color_set[3].name+'</option>'+
                    '<option data-color="'+color_set[4].color+'" value="progress-bar-red">'+color_set[4].name+'</option>'+
                    '<option data-color="'+color_set[5].color+'" value="color-purple">'+color_set[5].name+'</option>'+
                '</select>'+
            '</div>',
		setTitle:
            '<div class="form-group">'+
                '<label class="text-light-blue">'+const_title+'</label>'+
                '<input name="setTitle" type="text" class="form-control" placeholder="{% trans '輸入標題，空白時會自動隱藏'%}">'+
            '</div>',
		setTip:
            '<div class="form-group">'+
                '<label class="text-light-blue">'+const_tip+'</label>'+
                '<input type="text" name="setTip" class="form-control" placeholder="{% trans '輸入說明'%}">'+
            '</div>',
		setIcon:
            '<div class="form-group">'+
                '<label class="text-light-blue">'+const_icon+'</label>'+
                '<div></div>'+
                '<input name="showIcon" style="display:inline-block;width:20%;top:-2px;position:relative;text-align:center;" value="&#xf013" class="fa form-control" readOnly>'+
                '<select name="setIcon" style="display:inline-block;width:80%;" class="form-control select2">'+
                	'<option data-value="&#xf013" value="fa fa-gear">{% trans '齒輪'%}</option>'+
					'<option data-value="&#xf2e7" value="fa fa-cutlery">{% trans '餐具'%}</option>'+
					'<option data-value="&#xf0f4" value="fa fa-coffee">{% trans '咖啡'%}</option>'+
					'<option data-value="&#xf21e" value="fa fa-heartbeat">{% trans '心跳'%}</option>'+
					'<option data-value="&#xf1e0" value="fa fa-share-alt">{% trans '分享'%}</option>'+
					'<option data-value="&#xf2dc" value="fa fa-snowflake-o">{% trans '雪花'%}</option>'+
					'<option data-value="&#xf2c9" value="fa fa-thermometer-half">{% trans '溫度'%}</option>'+
					'<option data-value="&#xf164" value="fa fa-thumbs-up">{% trans '點讚'%}</option>'+
					'<option data-value="&#xf165" value="fa fa-thumbs-down">{% trans '倒讚'%}</option>'+
					'<option data-value="&#xf201" value="fa fa-line-chart">{% trans '折線圖'%}</option>'+
					'<option data-value="&#xf0ac" value="fa fa-globe">{% trans '地球'%}</option>'+
					'<option data-value="&#xf254" value="fa fa-hourglass">{% trans '沙漏'%}</option>'+
					'<option data-value="&#xf0e7" value="fa fa-bolt">{% trans '電力'%}</option>'+
					'<option data-value="&#xf007" value="fa fa-user">{% trans '使用者'%}</option>'+
					'<option data-value="&#xf0c0" value="fa fa-users">{% trans '群組'%}</option>'+
					'<option data-value="&#xf4ad" value="fa fa-comment-dots">{% trans '對話'%}</option>'+
					'<option data-value="&#xf277" value="fa fa-map-signs">{% trans '路標'%}</option>'+
					'<option data-value="&#xf084" value="fas fa-key">{% trans '鑰匙'%}</option>'+
					'<option data-value="&#xf071" value="fa fa-exclamation-triangle">{% trans '警告'%}</option>'+
					'<option data-value="&#xf1b9" value="fa fa-car">{% trans '汽車'%}</option>'+
					'<option data-value="&#xf207" value="fa fa-bus">{% trans '公車'%}</option>'+
					'<option data-value="&#xf239" value="fa fa-subway">{% trans '地鐵'%}</option>'+
					'<option data-value="&#xf21a" value="fa fa-ship">{% trans '船隻'%}</option>'+
					'<option data-value="&#xf072" value="fa fa-plane">{% trans '飛機'%}</option>'+
					'<option data-value="&#xf015" value="fa fa-home">{% trans '房屋'%}</option>'+
					'<option data-value="&#xf275" value="fa fa-industry">{% trans '工廠'%}</option>'+
					'<option data-value="&#xf200" value="fa fa-pie-chart">{% trans '圓餅圖'%}</option>'+
					'<option data-value="&#xf073" value="far fa-calendar-alt">{% trans '行事曆'%}</option>'+
					'<option data-value="&#xf290" value="fa fa-shopping-bag">{% trans '購物袋'%}</option>'+
					'<option data-value="&#xf07a" value="fa fa-shopping-cart">{% trans '購物車'%}</option>'+
					'<option data-value="&#xf0f3" value="fa fa-bell">{% trans '鈴鐺'%}</option>'+
					'<option data-value="&#xf1c0" value="fa fa-database">{% trans '資料庫'%}</option>'+
					'<option data-value="&#xf381" value="fa fa-cloud-download-alt">{% trans '下載'%}</option>'+
					'<option data-value="&#xf017" value="fa fa-clock-o">{% trans '時鐘'%}</option>'+
					'<option data-value="&#xf06c" value="fa fa-leaf">{% trans '葉子'%}</option>'+
					'<option data-value="&#xf0e0" value="fa fa-envelope">{% trans '信封'%}</option>'+
					'<option data-value="&#xf155" value="fas fa-dollar-sign">{% trans '金錢'%}</option>'+
					'<option data-value="&#xf109" value="fa fa-laptop">{% trans '電腦'%}</option>'+
					'<option data-value="&#xf02d" value="fa fa-book">{% trans '書籍'%}</option>'+
					'<option data-value="&#xf15c" value="fa fa-file-text">{% trans '文件'%}</option>'+
					'<option data-value="&#xf328" value="fas fa-clipboard">{% trans '剪貼板'%}</option>'+
					'<option data-value="&#xf044" value="fas fa-edit">{% trans '書寫'%}</option>'+
				'</select>'+
            '</div>',
        setForm:
            '<div class="form-group">'+
                '<label class="text-light-blue">'+const_form+'</label>'+
                '<select name="setForm" class="form-control select2" >'+
                    '<option value="">--'+const_form+'--</option>'+
                '</select>'+
            '</div>',
        setColumn:
            '<div class="form-group">'+
                '<label class="text-light-blue">'+const_column+'</label>'+
                '<select name="setColumn" class="form-control select2" >'+
                    '<option value="">--'+const_column+'--</option>'+
                '</select>'+
            '</div>',
        setRole:
        	'<div class="form-group">'+
                '<label class="text-light-blue">'+const_service_target+'</label>'+
                //'<div name="setRole" class="form-control" ></div>'+
                '<select name="setRole" class="form-control select2" style="width:100%;" multiple>'+
                    RoleArray_to_Option()+
                '</select>'+
            '</div>',
		setNull:
			'<div class="form-group">'+
				'<label>&nbsp;</label>'+
				'<input type="text" class="form-control" style="visibility: hidden;">'+
			'</div>'
	};
	
	$(function(){
		ServiceRoot_load();
		Grid_listForm();
		//console.log($('.content-wrapper').height()-$('.content-header').height()-50+'px');
		$('.box-primary').css('min-height', $('.content-wrapper').height()-$('.content-header').height()-50+'px');
		//檢查容量
		$('body').change(' #attachment_input',function(evt){
			if(evt.target.files==undefined)
				return;
			var output = [];
			for (var i = 0; i < evt.target.files.length; i++) {
				fileIdCounter++;
				var file = evt.target.files[i];
				var fileId = fileIdCounter;
				var file_size = omflowSizeUnit(file.size);
				
				fileTotalSize += Math.ceil(file.size/Math.pow(2, 20));
				filesToUpload.push({
					id: fileId,
					file: file
				});
				
				output.push('<li><div class="mailbox-attachment-info">'
					+'<p class="mailbox-attachment-name" style="word-break: break-all;"><i class="fa fa-paperclip"></i>&nbsp;&nbsp;'+file.name+'</p>'
					+'<span class="mailbox-attachment-size">'+file_size
					+'<button type="button" class="close pull-right" onclick="remove_upload(this,'+fileId+')">'
					+'<span aria-hidden="true">&times;</span></button></span>'
					+'</div></li>');
			}
			
			$('#attach_upload').append(output.join(""));
			evt.target.value = null;
			check_disk();
		});
		
		$(document).on('keypress',function(e) {
		    if(e.which == 13 && $("#service_keyword").is(':focus') ) {
		        Service_Search();
		    }
		});
	});
	function actions(data,status)
	{
		Swal.close();
		if(data.status == 200)
		{
			LSide();
			SweetAlert('success','{% trans '成功'%}');
		}	
		else if (data.status == 404)
		{
			omflowAlert('yellow', data.message);
		}
		else if (data.status == 500)
		{
			omflowAlert('blue', data.message);
		}
		else if (data.status == 403)
		{
			omflowAlert('red', data.message);
		}
	}	
    
    //產生初始儀表板物件
	function box_object(){
		var output = {};
		output["index"] = 1;
		output["list"] = {};
		output["tree"] = {0:[]};
		output["sort"] = [0];
		return output;
	}
	
    function ServiceRoot_input(item_id){
    	if(item_id!=0 && typeof(box_object.list[item_id])=="undefined")
    		return;
		$('#ServiceRoot').empty();
		box_container = item_id;
		var keyword = arguments[1]? $("#service_keyword").val().toLowerCase() : false;
		//重設路徑
		setPath(item_id);
		//設定active
		$("#ServiceList li").removeClass('active');
		$("#ServiceList li[id='ID_"+item_id+"']").addClass('active');
		
		//放置內容
		if(keyword)
			$.each(box_object.tree[box_container],function(idx,thisID){
				$.each(box_object.list,function(key,thisObj){
					if(thisObj.id==thisID && thisObj.type!="folder" 
					&& ( thisObj.setting.setTitle.toLowerCase().indexOf(keyword)>=0 || thisObj.setting.setTip.toLowerCase().indexOf(keyword)>=0))
						box_new_item(thisObj,'ServiceRoot');
				});
			});
		else
			$.each(box_object.tree[box_container],function(idx,thisID){
				$.each(box_object.list,function(key,thisObj){
					if(thisObj.id==thisID && thisObj.type!="folder")
						box_new_item(thisObj,'ServiceRoot');
				});
			});
		
		if(read_mode)
			DO_readmode();
		else
			UNDO_readmode();
	}
	
	function Service_Search(){
		var this_belong = $("#ServiceList .active:eq(0)").data("idx");
		if($("#service_keyword").val()){
			ServiceRoot_input(this_belong,$("#service_keyword").val());
		}else{
			ServiceRoot_input(this_belong);
		}
	}
	
    function UNDO_readmode(){
		
		//read_mode = false;
		$(".readHide").show();
		$(".borderHide").removeClass("no-border-top");
		$('#ServiceRoot div[id^=ID_]').prop( "draggable" , true );
		$('#ServiceList li[id^=ID_]').prop( "draggable" , true );
		$("#ServiceRoot .btn-box-tool").show();
		$("#ServiceList .btn-box-tool").show();
		//$(".box-header .pull-left").visible();
		//$(".box-header").show();
		$("#read-mode_edit").hide();
		$("#edit-mode_save").show();
		$("#edit-mode_cancel").show();
		$("#edit-mode_addS").show();
		$("#edit-mode_addF").show();
		$("#edit-mode_Trans").show();
		$("#edit-mode_Import").show();
		$("#edit-mode_Export").show();
		//$("#edit-mode_import").show();
		//$("#edit-mode_export").show();
	}
	function DO_readmode(){
		//read_mode = true;
		$(".readHide").hide();
		$(".borderHide").addClass("no-border-top");
		$('#ServiceRoot div[id^=ID_]').prop( "draggable" , false );
		$('#ServiceList li[id^=ID_]').prop( "draggable" , false );
		$("#ServiceRoot .btn-box-tool").hide();
		$("#ServiceList .btn-box-tool").hide();
		//$(".box-header .pull-left").invisible();
		$("#read-mode_edit").show();
		$("#edit-mode_save").hide();
		$("#edit-mode_cancel").hide();
		$("#edit-mode_addS").hide();
		$("#edit-mode_addF").hide();
		$("#edit-mode_Trans").hide();
		$("#edit-mode_Import").hide();
		$("#edit-mode_Export").hide();
		//$("#edit-mode_import").hide();
		//$("#edit-mode_export").hide();
	}
    function ServiceRoot_load(){
    	var postbody = {type:arguments[0]?arguments[0]:""};
		var callback = function(){
			data = arguments[0];
			if (data.status==200){
				box_object = data.result[0]?JSON.parse(data.result[0].content):box_object;
				//console.log(box_object);
				lan_package = null; //每次讀取清空翻譯
				try{
					$("#ServiceList").empty();
					$("#ServiceRoot").empty();
					ServiceRoot_build();
				}catch(e){
					$("#ServiceList").empty();
					$("#ServiceRoot").empty();
					box_object = {};
                    box_object["index"] = 1;
                    box_object["list"] = {};
                    box_object["tree"] = {0:[]};
                    box_object["sort"] = [0];
                    ServiceRoot_build();
				}
			}
			else
			{actions(data)}
		};
		omflowJsonAjax(postbody,"{% url 'loadServiceAjax'%}",callback);
	}
	
	function ServiceRoot_build(){
		
		//box_object.sort = [0,2,3];
		if(typeof(box_object.sort)=='undefined'){
			box_object.sort = [];
			$.each(box_object.tree,function(key,list){
				box_object.sort.push(key);
			});
		}
		
		$.each(box_object.sort,function(idx,item_id){
			if(item_id==0){
				$('#ServiceList').append('<li id="ID_0" data-idx=0 onclick="ServiceRoot_input(0)" draggable="true" ondragstart="boxdrag(event)" ondragover="boxAllowDrop(event)" ondrop="boxdrop(event,this)"><label>'+const_all+'</label></li>');
			}else{
				thisSer = box_object.list[item_id];
				if(thisSer.type=="folder"){
					box_new_item(thisSer,'ServiceList');
				}
			}
		});
		ServiceRoot_input(0);
		old_box_object = JSON.stringify(box_object);
	}
	
	function ServiceRoot_edit(){
		read_mode = false;
		ServiceRoot_load("source");
	}
	
	function ServiceRoot_save(){
		read_mode = true;
		
		old_box_object = JSON.stringify(box_object);
		var postdata = { content: JSON.stringify(box_object), lan_package:lan_package }
		var callback = function(){
			ServiceRoot_load();
		};
		omflowJsonAjax(postdata,"{% url 'saveServiceAjax'%}",callback);
		DO_readmode();
	}
	function ServiceRoot_cancel(){
		read_mode = true;
		ServiceRoot_load();
	}
	//設定路徑
	function setPath(item_id){
		var thisItem = $(".content-header:eq(0) a[data-idx="+item_id+"]")
		if(thisItem.length)
			thisItem.closest('li').nextAll().remove();
		else if(item_id!=0){
			$(".content-header:eq(0) a[data-idx=0]").closest('li').nextAll().remove();
			$(".content-header:eq(0) .breadcrumb").append('<li><a data-idx="'+item_id+'" style="cursor:pointer;"onclick="ServiceRoot_input('+item_id+')">'+box_object.list[item_id].setting.setTitle+'</a></li>');
			}
		}
	
	//設定Folder內順序
	function setTree(){
		box_object.tree[box_container] = [];
		$.each($(".omflow-board"),function(idx,thisDom){
			box_object.tree[box_container].push(parseInt($(thisDom).attr("id").substring(3)));
		});
		
		box_object.sort = [];
		$.each($("#ServiceList li"),function(idx,thisDom){
			box_object.sort.push(parseInt($(thisDom).attr("id").substring(3)));
		});
	}
	
	function add_service(){
		Grid_listForm();
		$("#modal-service-new").modal('show');
	}
    //區塊-新增區塊
    function add_object(){
    	var type = arguments[0];
    	var api_path = $("#modal-service-new select").val();
    	switch(type){
	    	case "service":
	    		var item = {
					id:box_object.index++,
					type:type,
					available:1,
					belong:box_container,
					api_path:api_path,
					setting:{
						setTitle:$("#modal-service-new option[value="+api_path+"]").text(),
						setTip:const_tip,
						setIcon:"fas fa-edit",
						setColor:0,
						setRole:[-1]
					},
					service:{
						index:1,
						list:{
							0:{
								name:const_first_step,
								tip:"",
								rows:1,
								column_list:[]
							},
						},
						tree:[0]
					},
					default_value:[]
				}
				
			box_new_item(item,'ServiceRoot');
			$("#modal-service-new").modal("hide");
	    	break;
	    	case "folder":
	    		var item = {
					id:box_object.index++,
					type:type,
					belong:0,
					setting:{
						setTitle:const_folder
					}
				}
			box_new_item(item,'ServiceList');
	    	break;
    	}
	}
	
	//窗格-判斷為刪除或移動
	function box_button_remove_item_confirm(item_id){
		var item = box_object.list[item_id];
		if( $('#ID_0').hasClass('active') ){
			var callback = function(){
				box_button_remove_item(item_id);
			};
			var icon = "fa fa-trash-o";
			var title = const_delete_service;
			var content = const_deleting_1+item.setting.setTitle+const_deleting_2;
			omflowConfirmDialogue(icon,title,content,callback);
		}else{
			$('#ID_' + item_id).remove();
			box_resetGroup(item,0,true);
		}
	}
	
	//窗格-移除 NEWTYPE //待整理  刪除物件 要在兩個tree跟list
	function box_button_remove_item(item_id){
		var item = box_object.list[item_id];
		function delObj(this_id){
			//移除list
			delete box_object.list[this_id];
			//移除tree[0]
			var idx = $.inArray( parseInt(this_id), box_object.tree[0]);
		    if( idx!=-1 ){
		    	box_object.tree[0].splice(idx,1);
		    }
		    //移除Dom
			$('#ID_' + item_id).remove();
		}
		
		
		//如果是資料夾
		//if(typeof(box_object.tree[item_id])!='undefined'){
		//console.log(item.type);
		if( item.type=='folder'){
    		//console.log('tree');
    		//移除sort
    		var sortIdx = $.inArray( parseInt(item_id), box_object.sort);
    		if(sortIdx!=-1){
	    		//console.log('sort');
			    box_object.sort.splice(sortIdx,1);
    		}
    		
    		//$.each( box_object.tree[item_id], function(idx,thisIdx){
    			//delObj(thisIdx);
    		//});
    		delete box_object.tree[item_id];
    		delObj(item_id);
    		ServiceRoot_input(0);
    	}else{
    		delObj(item_id);
			//每個tree刪除該物件
	    	$.each( box_object.tree, function(tree_id,thisList){
	    		var idx = $.inArray( parseInt(item_id), thisList);
			    if( idx!=-1 ){
			    	thisList.splice(idx,1);
			    }
	    	});
    	}
	}
	
	function box_move_item(item,target_id){
		if( $('#ID_'+target_id).hasClass('active') ){
		
		}else if($('#ID_0').hasClass('active')){
			box_resetGroup(item,target_id,false);
		}else{
			$('#ID_' + item.id).remove();
			box_resetGroup(item,target_id,true);
		}
	}
	
	function box_resetGroup(item,target_id,leave){
		//當前資料夾移除該服務
		if(leave){
			var idx = $.inArray( parseInt(item.id), box_object.tree[box_container]);
		    if( idx!=-1 ){
		    	box_object.tree[box_container].splice(idx,1);
		    }
		}
		if(typeof(box_object.tree[target_id])!="undefined"){
			if($.inArray(item.id,box_object.tree[target_id])==-1)
				box_object.tree[target_id].push(item.id);
		}else{
			box_object.tree[target_id]=[item.id];
		}
		//判斷root有沒有
		if(typeof(box_object.tree[0])!="undefined"){
			if($.inArray(item.id,box_object.tree[0])==-1)
				box_object.tree[0].push(item.id);
		}else{
			box_object.tree[0]=[item.id];
		}
	}
	
	//區塊-新增窗格-執行 NEWTYPE
	function box_new_item(item,container){
		box_object.list[item.id]=item;
		//判斷指定資料夾
		if(typeof(box_object.tree[box_container])!="undefined"){
			if($.inArray(item.id,box_object.tree[box_container])==-1)
				box_object.tree[box_container].push(item.id);
		}else{
			box_object.tree[box_container]=[item.id];
		}
		//判斷root有沒有
		if(typeof(box_object.tree[0])!="undefined"){
			if($.inArray(item.id,box_object.tree[0])==-1)
				box_object.tree[0].push(item.id);
		}else{
			box_object.tree[0]=[item.id];
		}
		
	    var content = '';
	    var drag = ' draggable="true" ondragstart="boxdrag(event)" ondragover="boxAllowDrop(event) "';
	    var drop = ' ondrop="boxdrop(event,this)" ';
	    var display_mode = '';
	    var config_button = '<button type="button" class="btn btn-box-tool pull-right" style="z-index:51; padding:0px 5px;" onclick="box_active_item(\'_p_id_\',\'_item_type_\')" '+display_mode+'><i class="fa fa-gear"></i></button>';
	    var	remove_button = '<button type="button" class="btn btn-box-tool pull-right" style="z-index:51; padding:0px 5px;" onclick="box_button_remove_item_confirm(\'_p_id_\')" '+display_mode+'><i class="fa fa-remove"></i></button>';
	    var	add_button = '<button type="button" class="btn btn-box-tool pull-right" style="z-index:51;" onclick="box_button_add_item(\'_p_id_\',\'_item_type_\')" '+display_mode+'><i class="fa fa-plus"></i></button>';
	    
	    switch(item.type)
	    {
	        case 'folder':
	        	var li_config_button = '<button type="button" class="btn btn-box-tool move-in pull-right" style="z-index:51;" onclick="box_button_config_item(\'_p_id_\',\'_item_type_\')" '+display_mode+'><i class="fa fa-gear"></i></button>';
	    		var	li_remove_button = '<button type="button" class="btn btn-box-tool move-in pull-right" style="z-index:51;" onclick="box_button_remove_item(\'_p_id_\')" '+display_mode+'><i class="fa fa-remove"></i></button>';
		    	content = '<li id="ID__p_id_" data-idx=_p_id_ ' + drag + drop + ' onclick="ServiceRoot_input('+item.id+')">'
			    			+'<div class="omflow-box-header readHide move-in">&nbsp;'
		                    + li_remove_button + li_config_button
		                    +'</div>'
		                    +'<label id="TITLE__p_id_">'+item.setting.setTitle+'</label>'
		                    +'</li>';
	        	//判斷有沒有
				if(typeof(box_object.sort)!="undefined"){
					if($.inArray(item.id,box_object.sort)==-1)
						box_object.sort.push(item.id);
				}else{
					box_object.sort=[item.id];
				}
	        break;
	        case 'service':
	        	var width = 4;
	            content ='<div id="ID__p_id_" data-idx=_p_id_ class="col-md-'+width+' omflow-board move-down"' + drag + drop + ' style="margin-bottom: 0px;">'
						+'<div class="omflow-box-header readHide move-in"><p id="TITLE__p_id_"></p>'
	                    + remove_button + config_button
	                    +'</div>'
	                    +'<div id="CONTENT__p_id_" class="omflow-box-body" onclick="box_active_item(\'_p_id_\',\'_item_type_\')"></div>'
	                    +'</div>';
	        break;
	    }
	    content = content.replace(/_p_id_/g,item.id).replace(/_item_type_/g,item.type);

	    $('#' + container).append(content);
	    box_init_item(item);
	}

	//窗格-重新設定 NEWTYPE
	function box_init_item(item){
		var thisDom = $("#ID_"+item.id);
	    if(!read_mode || !item.setting.setTitle){
	    	$("#ID_"+item.id+">.omflow-box-header").show();
	    }
	    switch(item.type){
	    	case "folder":
	    		thisDom.find("#TITLE_"+item.id).text(item.setting.setTitle);
	    	break;
	    	case "service":
	    		var available = item.available? '':'<font color="red"> '+const_off_shelf+'</font>';
	        	thisDom.find("#CONTENT_"+item.id).empty().append(
					'<span class="omflow-box-icon" ><i class="'+item.setting.setIcon+'" style="color:'+color_set[item.setting.setColor].color+';"></i></span>'
					+'<div class="omflow-box-title">'+item.setting.setTitle+available+'</div>'
					+'<div class="omflow-box-txt">'+item.setting.setTip+'</div>'
		    	);
	    	break;
	    }
	}
	
	//窗格-窗格互動
	function box_active_item(item_id,item_type){
		if(item_type=="folder"){
			ServiceRoot_input(item_id);
		}else{
			if(box_object.list[item_id].available){	
				box_button_config_item(item_id, item_type, "service")
				Service_Load(item_id);
			}
		}
	}
	
    //窗格-編輯 NEWTYPE	
    function box_button_config_item(item_id, item_type, type){
		var item = box_object.list[item_id];
		
		var thisDialog = type=="service"? $("#tab-setting") : $("#modal-folder-config");
			thisDialog.attr('name',item_id);
		switch(item_type)
		{
			case 'service':
				Grid_buildAdvance(["setTitle","setTip","setIcon","setChartColor","setRole"],item_type);
				break;
			case 'folder':
				Grid_buildAdvance(["setTitle"],item_type);
				break;
		}
		$.each(item.setting,function(key,val){
			thisDialog.find('[name='+key+']:eq(0)').val(val);
			if(key=="setColor"||key=="setIcon")
				thisDialog.find('[name='+key+']:eq(0)').trigger('change');
			if(key=="setRole"){
				thisDialog.find('[name=setRole]:eq(0)').select2ToTree();
			}
		});
		if(type!="service")
			thisDialog.modal('show');
	}
    function Grid_buildAdvance(){
    	
        var thisList = arguments[0];
        var type = arguments[1];
        var count=1;
        var thisDialogBody = type=="service"? $("#tab-setting").find("table").empty() : $("#modal-folder-config").find("table:eq(0)").empty();
        $.each(thisList,function(idx,name){
            if(count%2)
                thisDialogBody.append($('<tr><td style="width:50%;padding-right:7px;"></td></tr>'));
            else
                thisDialogBody.find("tr:last").append($('<td style="width:50%;padding-left:7px;"></td>'));
            var thisTD = thisDialogBody.find("td:last");
            thisTD.append($(config_set[name]));
            count++
        });
    }
    function Grid_submit(type){
		var thisDialog = type=="service"? $("#tab-setting") : $("#modal-folder-config");
		var item_id = thisDialog.attr('name');
		var item = box_object.list[item_id];
		var thisSetting = {};
		
		thisDialog.find('[name^=set]').each(function(i){
			var thisSet = $(this);
			if($.inArray( thisSet.attr('name'), ["setColumn","setType","setGroup","setOrder"])>-1){
				if(typeof(thisSetting[thisSet.attr('name')])=='undefined')
					thisSetting[thisSet.attr('name')] = []
				thisSetting[thisSet.attr('name')].push(thisSet.val());
			}else{
				var thisRole = thisSet.val();
				for (i = 0; i < thisRole.length; i++) {
					thisRole[i] = parseInt(thisRole[i]);
				}
				thisSetting[thisSet.attr('name')] = thisRole;
			}
		});
		
		item.setting = thisSetting;
		if(type!="service")
			$('#modal-folder-config').modal('hide');
		box_init_item(item);
		
		item_id = undefined;
		thisSetting = undefined;
	}
	function Grid_listForm(){
		if(form_list==null){
			var callback = function(){
				data = arguments[0];
				if (data.status==200){
					form_list = {};
					form_list.app = data.result.app;
					form_list.flow = data.result.flow;
					thisSelect=$("#modal-service-new select[name=setForm]").empty();
					$.each(form_list.app,function(idx,item){
						thisSelect.append($('<option value="'+item.id+'" class="l1 non-leaf" disabled="disabled">'+item.app_name+'</option>'))
					});
					$.each(form_list.flow,function(idx,item){
						thisSelect.find('option[value="'+item.flow_app_id+'"]').after($('<option value="'+item.api_path+'" data-id="'+item.id+'" data-pup="'+item.flow_app_id+'" class="l2">'+item.flow_name+'</option>'))
					});
					
					thisSelect.select2ToTree();
				}
				else
				{actions(data)}
			};
			omflowJsonAjax({},"{% url 'getFormListAjax'%}",callback);
		}else{
			thisSelect=$("#modal-service-new select[name=setForm]").empty();
			$.each(form_list.app,function(idx,item){
				thisSelect.append($('<option value="'+item.id+'" class="l1 non-leaf" disabled="disabled">'+item.app_name+'</option>'))
			});
			$.each(form_list.flow,function(idx,item){
				thisSelect.find('option[value="'+item.flow_app_id+'"]').after($('<option value="'+item.api_path+'" data-id="'+item.id+'" data-pup="'+item.flow_app_id+'" class="l2">'+item.flow_name+'</option>'))
			});
			
			thisSelect.select2ToTree();
		}	
	}
	
	
	function Service_listColumn(type){
		var thisSelect = $('#modal-service-add-column');
			thisSelect.find('select').empty();
		var thatDialog = $('#service-grid-config');
		$.each(form_object.items,function(idx,thisCol){
			if(thisCol.type.indexOf('box')!=0 && thatDialog.find('li[data-id='+thisCol.id+']').length==0){
				if(thisCol.type=="h_group"){
					var require = thisCol.config.require ? true: thisCol.config.user_require ? true : false;
					if(require)
						thisSelect.find('select').append('<option style="color:red;" value='+thisCol.id+'>'+thisCol.config.group_title+'('+const_require+')</option>');
					else
						thisSelect.find('select').append('<option value='+thisCol.id+'>'+thisCol.config.group_title+'</option>');
				}else{
					var require = thisCol.config.require ? true: false;
					if(require)
						thisSelect.find('select').append('<option style="color:red;" value='+thisCol.id+'>'+thisCol.config.title+'('+const_require+')</option>');
					else
						thisSelect.find('select').append('<option value='+thisCol.id+'>'+thisCol.config.title+'</option>');
				}
			}
		});
				
		if(type=="default"){
			thisSelect.find("button[name=normal-col]:eq(0)").hide();
			thisSelect.find("button[name=default-col]:eq(0)").show();
		}else{
			if(form_object.attachment && thatDialog.find('li[data-id^="COL_UPLOAD"]').length==0)//表單允許上傳
				thisSelect.find('select').append(
					'<option value="COL_UPLOAD1" >'+'{% trans '強制上傳檔案'%} '+'</option>'+
					'<option value="COL_UPLOAD0" >'+const_upload_file+'</option>'
					);
			thisSelect.find("button[name=default-col]:eq(0)").hide();
			thisSelect.find("button[name=normal-col]:eq(0)").show();
		}
		if(thisSelect.find('select option').length){
			thisSelect.modal('show');
			thisSelect.off('hidden.bs.modal');
			thisSelect.on('hidden.bs.modal', function () {
				thisSelect.off('hidden.bs.modal');
			    $('.modal:visible').css('overflow','auto');
			});
		}else
			actions({status:500, message:const_none_column});
		//BindSwitchModal(thatDialog,thisSelect);
		//BindSwitchModal(thisSelect,thatDialog);
		//thatDialog.modal('hide');
	}
	
	//讀取服務需求
	function Service_Load(item_id){
	
		var thisItem = box_object.list[item_id];
		var thisDialog = $('#service-grid-config').attr('name',item_id);
		thisDialog.find(".td-tab").empty();
		thisDialog.find(".td-content").empty();
		
		//顯示按鈕
		var display="";
		var readOnly="";
		if(read_mode){
			thisDialog.find("#service-grid-title").text(thisItem.setting.setTitle);
		
			readOnly = "readOnly"; //for步驟
			display = "display:none;"; //for步驟
			thisDialog.find(".cls_edit").hide();
			thisDialog.find("#service-tab>ul").hide();
			thisDialog.find("#service-tab").removeClass("nav-tabs-custom");
		}else{
			var thisFlow = form_list.flow.find(function(item, index, array){
				return item.api_path == thisItem.api_path;
			});
			thisDialog.find("#service-grid-title").text(thisItem.setting.setTitle+" ( "+thisFlow.flow_name+" )");
		
			thisDialog.find(".cls_edit").show();
			thisDialog.find("#service-tab>ul").show();
			thisDialog.find("#service-tab").addClass("nav-tabs-custom");
		}
		//讀取formObj
		var postdata = { api_path:box_object.list[item_id].api_path };
		var callback = function(){
			data = arguments[0];
			if (data.status==200 && data.result.formobject){
				form_object = JSON.parse(data.result.formobject);
				form_object.attachment = data.result.attachment;
				//console.log(form_object.items);
				column_object = {};
				$.each(form_object.items,function(idx,thisCol){
					if(thisCol.type.indexOf('box')!=0){
						column_object[thisCol.id] = thisCol;
					}
				});
				
				var needFirstStep = true;
				var FirstStep_id = "";
				$.each(thisItem.service.tree,function(idx,step_id){
					var thisI = read_mode?'':'<i style="'+display+'" class="fa fa-remove" onclick="Step_remove('+step_id+')"></i>';
					if(needFirstStep){
						FirstStep_id = step_id;
						needFirstStep = false;
						thisI ='';
					}
					
					var thisStep = thisItem.service.list[step_id];
					
					thisDialog.find(".td-tab").append(
						$(
						'<div data-step="'+step_id+'" class="tablinks" onclick="Step_Switch('+item_id+','+step_id+')">'+
							'<input type="text" value="'+thisStep.name+'" '+readOnly+'>'+
							thisI+
						'</div>'
						)
					);
					//判斷有無TIP
					var thisTip = thisStep.tip?thisStep.tip:null;
					var thisRows = thisTip? thisTip.split("\n").length:1;
					var thisHeight = thisRows*20 + 20;
					//thisDialog.find("#tab-step .td-content").append($('<div data-step="'+step_id+'" class="tabcontent"><textarea type="text" spellcheck="false" class="syscom-tip"'+readOnly+'></textarea><ul></ul></div>'));
					thisDialog.find("#tab-step .td-content").append($('<div data-step="'+step_id+'" class="tabcontent"><ul class="tabcontent-ul"></ul><textarea type="text" placeholder="'+const_remind_tip+'" spellcheck="false" style="height:'+thisHeight+'px" class="syscom-tip"'+readOnly+'></textarea></div>'));
					
					Step_addCol(thisStep.column_list,step_id,null);
					
					thisRows = undefined;
					thisHeight = undefined;
				});
				
				//導入預設值
				thisDialog.find("#tab-default .td-content").append($('<div data-step="default" class="tabcontent"><ul class="tabcontent-ul"></ul></div>'));
				
				$.each(thisItem.default_value,function(idx,valueObj){
					F_obj = {}
					F_obj[valueObj.id] = valueObj.value;
					Step_addCol([valueObj.id],"default",F_obj);
				});
				
				if(!read_mode){
					thisDialog.find(".tablinks").css("cursor","move");
					thisDialog.find(".tabcontent-ul").sortable();
					thisDialog.find(".td-tab").sortable();
					autosize(thisDialog.find(".syscom-tip"));
				}else{
					thisDialog.find(".tablinks").css("cursor","pointer");
					thisDialog.find(".tablinks input").css("cursor","pointer");
					thisDialog.find(".syscom-tip").css("cursor","default");
				}	
				Step_Switch(item_id,FirstStep_id);
				$("#service-tab").tabs();
				if(read_mode)
					$("#service-tab").tabs("option", "active", 1);
				else{
					$("#service-tab>ul>li").removeClass("active");
					$("#service-tab>ul>li:eq(0)").addClass("active");
					$("#service-tab").tabs("option", "active", 0);
				}
				HideBodyScrollModal(thisDialog);
			}
			else
			{//actions(data)
			}
		};
		
		omflowJsonAjax(postdata,"{% url 'getFormObjAjax'%}",callback);
	}
	
	//新增步驟
	function Step_add(){
		var thisDialog = $("#service-grid-config");
		var item_id = thisDialog.attr('name');
		var step_id = box_object.list[item_id].service.index++;
		thisDialog.find(".td-tab").append($( 
			'<div data-step="'+step_id+'" class="tablinks" onclick="Step_Switch('+item_id+','+step_id+')">'+
				'<input type="text" value="'+const_new_step+'" >'+
				'<i class="fa fa-remove" onclick="Step_remove('+step_id+')"></i>'+
			'</div>'));
		thisDialog.find("#tab-step .td-content").append($('<div data-step="'+step_id+'" class="tabcontent" style="display:none;"><ul class="tabcontent-ul"></ul><textarea type="text" placeholder="'+const_remind_tip+'" spellcheck="false" class="syscom-tip"></textarea></div>'));
		thisDialog.find("[data-step='"+step_id+"'] .tabcontent-ul").sortable();
		autosize(thisDialog.find('[data-step="'+step_id+'"] .syscom-tip'));
		Step_Switch(item_id,step_id);
	}
	
	//刪除步驟
	function Step_remove(step_id){
		var thisDialog = $("#service-grid-config");
		var thisTab = thisDialog.find('.tablinks[data-step='+step_id+']:eq(0)');
		var pre_step_id = thisTab.prev().data('step');
		thisTab.remove();
		thisDialog.find('.tabcontent[data-step='+step_id+']:eq(0)').remove();
		Step_Switch(thisDialog.attr('name'),pre_step_id);
	}
		
	//新增欄位
	function Step_addCol(){
		var thisDialog = $("#service-grid-config");
		var step_id = null!=arguments[1]? arguments[1]:thisDialog.find(".tablinks.active:eq(0)").data('step');
		var thisTabContent = thisDialog.find('.tabcontent[data-step='+step_id+']:eq(0) .tabcontent-ul');
		var thisCol_List = arguments[0]? arguments[0] : [$("#modal-service-add-column select").val()];
		var thisValue_List = arguments[2];
		
		var moveable = read_mode?'':'cursor: move;';
		$.each(thisCol_List,function(idx,Col_id){
			if( Col_id=="level" || Col_id=="title" || Col_id=="status" || Col_id=="group")
				return;
			else if( (Col_id=="COL_UPLOAD1"||Col_id=="COL_UPLOAD0") && form_object.attachment){//附加檔案欄位
				var require = Col_id=="COL_UPLOAD1"? '<font color="red"> *</font>' : "";
				var display = read_mode?'':'display:none;';
				var thisI = read_mode?'':Col_id=="COL_UPLOAD1"?
					'<i class="fa fa-remove column-remove" onclick="Remove_Column(\'COL_UPLOAD1\')"></i>':
					'<i class="fa fa-remove column-remove" onclick="Remove_Column(\'COL_UPLOAD0\')"></i>';
				thisTabContent.append(
					'<li class="form-group" style="width:100%;" id="'+Col_id+'" data-id="'+Col_id+'" data-type="file">'+
		                '<label class="text-light-blue">'+ const_upload_file + require +'</label>'+
		                thisI+
		                '<button class="btn btn-default btn-file" style="margin:0px 4px 10px 0px;display:block;" >'+
		                '<i class="fa fa-file-archive"></i> '+const_choice_file+
		                	'<input type="file" style="'+display+'" class="file" id="attachment_input" name="attachment_input" multiple="multiple" >'+
		                '</button>'+
		                '<label name="fileWarning" class="text-red" style="display:none;">{% trans '硬碟容量不足，請移除部分檔案再上傳或聯絡系統管理員'%}</label>'+
		            '</li>'
		        );
		        thisTabContent.after('<ul class="clearfix" id="attach_upload"></ul>');
				
			}else if(column_object[Col_id]){
				var thisCol = column_object[Col_id];
				var thisI = read_mode?'':'<i class="fa fa-remove column-remove" onclick="Remove_Column(\''+thisCol.id+'\')"></i>';
				var require = thisCol.config.require ? '<font color="red"> *</font>':'';
				var readonly = step_id=="default" ? '' : thisCol.config.readonly||read_mode==false ? 'readonly disabled' :'';
				var thisValue = thisValue_List? thisValue_List[Col_id] : thisCol.config.value?thisCol.config.value :"";
				
				//var content = $('<div id="COL_'+thisCol.id+'" name='+thisCol.id+' class="col-md-6"></div>');
				switch(thisCol.type){
					case "h_title":
						thisTabContent.append(
							'<li class="form-group" style="'+moveable+'" id="COL_'+thisCol.id+'" data-id="'+thisCol.id+'" data-type="'+thisCol.type+'">'+
				                '<label class="text-light-blue">'+ thisCol.config.title + require +'</label>'+
				                thisI+
				                '<input id="formcontent_' + thisCol.id + '_item" name="setValue" type="text" value="'+thisValue+'" placeholder="'+thisCol.config.placeholder+'" class="form-control" '+readonly+'>'+
				            '</li>'
				            );
				    break;
					case "date":
						thisTabContent.append(
							'<li class="form-group" style="'+moveable+'" id="COL_'+thisCol.id+'" data-id="'+thisCol.id+'" data-type="'+thisCol.type+'">'+
				                '<label class="text-light-blue">'+ thisCol.config.title + require +'</label>'+
				                thisI+
				                '<input id="formcontent_' + thisCol.id + '_item" name="setValue" type="text" value="'+thisValue+'" placeholder="'+thisCol.config.placeholder+'" autocomplete="off" class="form-control" '+readonly+'>'+
				            '</li>'
				            );
				        if(step_id=="default"||!thisCol.config.readonly||read_mode){
				        	thisTabContent.find('#formcontent_' + thisCol.id + '_item').datetimepicker({minView:'month',format:'yyyy-mm-dd',language:getCookie('django_language'),autoclose:true,todayHighlight:true});
				        }
				    break;
					case "datetime":
						thisTabContent.append(
							'<li class="form-group" style="'+moveable+'" id="COL_'+thisCol.id+'" data-id="'+thisCol.id+'" data-type="'+thisCol.type+'">'+
				                '<label class="text-light-blue">'+ thisCol.config.title + require +'</label>'+
				                thisI+
				                '<input id="formcontent_' + thisCol.id + '_item" name="setValue" type="text" value="'+thisValue+'" placeholder="'+thisCol.config.placeholder+'" autocomplete="off" class="form-control" '+readonly+'>'+
				            '</li>'
				            );
				        if(step_id=="default"||!thisCol.config.readonly||read_mode){
				        	thisTabContent.find('#formcontent_' + thisCol.id + '_item').datetimepicker({format:'yyyy-mm-dd hh:ii:ss',language:getCookie('django_language'),autoclose:true,todayHighlight:true});
				        }
					break;
					case "h_status":
						var content = $('<li class="form-group" style="'+moveable+'" id="COL_'+thisCol.id+'" data-id="'+thisCol.id+'" data-type="'+thisCol.type+'">'+
				                '<label class="text-light-blue">'+ thisCol.config.title + require +'</label>'+
				                thisI+
				                '<select id="formcontent_' + thisCol.id + '_item" name="setValue" value="'+thisValue+'" class="form-control select2" style="width: 100%;" '+readonly+'>' + Array_to_Option(thisCol) + '</select>'+
				            '</li>');
				        content.find('select').val(thisValue);
						thisTabContent.append(content);
					break;
					case "inputbox":
						var thisInputType = thisCol.config.type;
						thisTabContent.append(
							'<li class="form-group" style="'+moveable+'" id="COL_'+thisCol.id+'" data-id="'+thisCol.id+'" data-type="'+thisCol.type+'">'+
				                '<label class="text-light-blue">'+ thisCol.config.title + require +'</label>'+
				                thisI+
				                '<input id="formcontent_' + thisCol.id + '_item" name="setValue" type="'+thisInputType+'" value="'+thisValue+'" placeholder="'+thisCol.config.placeholder+'" class="form-control" '+readonly+'>'+
				            '</li>'
						);
					break;
					case "areabox":
						var content = $('<li class="form-group" style="'+moveable+'" id="COL_'+thisCol.id+'" data-id="'+thisCol.id+'" data-type="'+thisCol.type+'">'+
				                '<label class="text-light-blue">'+ thisCol.config.title + require +'</label>'+
				                thisI+
				                '<textarea id="formcontent_' + thisCol.id + '_item" name="setValue" rows="' + thisCol.config.rows + '" class="form-control" '+readonly+'></textarea>'+
				            '</li>');
				        content.find('textarea').val(thisValue);
						thisTabContent.append(content);
					break;
					case "list":
						var content = $('<li class="form-group" style="'+moveable+'" id="COL_'+thisCol.id+'" data-id="'+thisCol.id+'" data-type="'+thisCol.type+'">'+
				                '<label class="text-light-blue">'+ thisCol.config.title + require +'</label>'+
				                thisI+
				                '<select id="formcontent_' + thisCol.id + '_item" name="setValue" value="'+thisValue+'" class="form-control select2" '+readonly+'>' + Array_to_Option(thisCol) + '</select>'+
				            '</li>');
				        content.find('select').val(thisValue);
						thisTabContent.append(content);
				    break;
					case 'h_level':
						var content = $('<li class="form-group" style="'+moveable+'" id="COL_'+thisCol.id+'" data-id="'+thisCol.id+'" data-type="'+thisCol.type+'" >'+
				                '<label class="text-light-blue">'+ thisCol.config.title + require +'</label>'+
				                thisI+
				                '<select id="formcontent_' + thisCol.id + '_item" name="setValue" value="'+thisValue+'" class="form-control select2" '+readonly+'>' + Array_to_Option(thisCol) + '</select>'+
				            '</li>');
				        content.find('select').val(thisValue);
						thisTabContent.append(content);
					break;
					case 'h_group':
						var user_require = thisCol.config.user_require ? '<font color="red"> *</font>':'';
						
						thisTabContent.append(
							'<li class="form-group" style="'+moveable+'" id="COL_'+thisCol.id+'" data-id="'+thisCol.id+'" data-type="'+thisCol.type+'" >'+
				                '<label class="text-light-blue">'+ thisCol.config.group_title + require +'</label>'+
				                thisI+
				                '<select id="formcontent_' + thisCol.id + '_group_item" name="setValue1" class="form-control " style="width:100%;" '+readonly+'>' + 
				                GroupArray_to_Option() + 
				                '</select>'+
				                '<label style="margin-top:15px;" class="text-light-blue">'+ thisCol.config.user_title + user_require +'</label>'+
				                '<select id="formcontent_' + thisCol.id + '_user_item" name="setValue2" class="form-control " '+readonly+'>' + '</select>'+
				            '</li>'
				        );
				        var thisGroup = "";
				        var thisUser = "";
				        if(step_id=="default"){
				        	thisGroup = thisValue.group;
				        	thisUser = thisValue.user;
				        }else if(thisValue.length){
				        	thisGroup = thisValue.split(',')[0];
				        	thisUser = thisValue.split(',')[1];
				        }
				        
				        thisTabContent.find("[name=setValue1]").val(thisGroup).change(function(){
				        	thisTabContent.find("[name=setValue2]").empty().append(
				        		GroupUserArray_to_Option(thisTabContent.find("[name=setValue1]").val())
				        	);
				        }).trigger('change').select2ToTree();
				        thisTabContent.find("[name=setValue1]").next().css("display","block");
				        thisTabContent.find("[name=setValue2]").val(thisUser);
					break;
					case 'checkbox':
						thisValue = thisValue.split(",");
						thisTabContent.append(
							'<li class="form-group" style="'+moveable+'" id="COL_'+thisCol.id+'" data-id="'+thisCol.id+'" data-type="'+thisCol.type+'" >'+
				                '<label class="text-light-blue">'+ thisCol.config.title + require +'</label>'+
				                thisI+
				                '<div id="formcontent_' + thisCol.id + '_item">' + Array_to_CheckBox(thisCol) + '</div>'+
				            '</li>'
				        );
				        for(i=0;i<thisValue.length;i++){
				        	if(thisValue!="" && thisValue.length)
				        		thisTabContent.find('input[value='+thisValue[i]+']').prop('checked',true);
				        }
					break;
					case "subquery":
						thisTabContent.append(
							'<li class="form-group" style="'+moveable+'" id="COL_'+thisCol.id+'" data-id="'+thisCol.id+'" data-type="'+thisCol.type+'">'+
				                '<label class="text-light-blue">'+ thisCol.config.title + require +'</label>'+
				                thisI+
				                '<div class="input-group" style="width:100%">'+
				                	'<input id="formcontent_' + thisCol.id + '_item" name="setValue" type="'+thisInputType+'" value="'+thisValue+'" placeholder="'+thisCol.config.placeholder+'" class="form-control" '+readonly+'>'+
				                	'<span class="input-group-btn"><button type="button" onclick="SubQuery(\''+thisCol.id+'\')" class="btn btn-info btn-flat"><i class="fa fa-search"></i></button></span>'+
				            	'</div>'+
				            '</li>'
				         );
						
				}
			}
			var addDialog = $("#modal-service-add-column");
			if(!addDialog.is(":hidden"))
				addDialog.modal('hide');
		});
	}
	
	function Remove_Column(col_id){
		$("#service-grid-config").find('li[data-id='+col_id+']').remove();
	}
	
	//切換步驟
	function Step_Switch(item_id,step_id){
		var thisDialog = $('#service-grid-config');
		var thisTxtarea = thisDialog.find('.tabcontent[data-step='+step_id+']:eq(0) .syscom-tip');
		var thisDom = thisDialog.find('.tablinks[data-step='+step_id+']');
		if(thisDom.length==0)
			return;
		var thisItem = box_object.list[item_id];
		var thisStep = thisItem.service.list[step_id];
		
		if(thisStep){
			var thisTip = thisStep.tip?thisStep.tip:null;
			if(read_mode && !thisTip){
				thisTxtarea.hide();
			}else{
				thisTxtarea.val(thisTip).show();
			}
		} 
		thisDialog.find('#tab-step .tabcontent').hide();
		thisDialog.find('.tablinks').removeClass("active");
		thisDialog.find('.tabcontent[data-step='+step_id+']').show();
		thisDom.addClass("active");
		
		if(read_mode){
			//判斷有無下一步驟
			if(thisDom.nextAll().length){
				thisDialog.find('.cls_submit').hide();
				thisDialog.find('.cls_save').hide();
				thisDialog.find('.cls_next').show().off('click').on('click',function(){
					Step_Switch(item_id,thisDom.next().data('step'));
				})
			}else{
				thisDialog.find('.cls_next').hide();
				thisDialog.find('.cls_save').hide();
				thisDialog.find('.cls_submit').show();
			}
			
			//判斷有無上一步驟
			if(thisDom.prevAll().length){
				thisDialog.find('.cls_cancel').hide();
				thisDialog.find('.cls_last').show().off('click').on('click',function(){
					Step_Switch(item_id,thisDom.prev().data('step'));
				})
			}else{
				thisDialog.find('.cls_last').hide();
				thisDialog.find('.cls_cancel').show();
			}
		}else{
			thisDialog.find('.cls_next').hide();
			thisDialog.find('.cls_submit').hide();
			thisDialog.find('.cls_save').show();
			thisDialog.find('.cls_last').hide();
			thisDialog.find('.cls_cancel').show();
		}
		
		//Service_buildColumn(thisDialog.find('.tabcontent[data-step='+step_id+'] table'),thisStep.json)		
		thisDialog = undefined;
		thisItem = undefined;
		thisTip = undefined;
	}
	
	//取得指定DIV下欄位值
	function getFormdata(thisDialog){
		var thisDialog = $(thisDialog);
		var data = [];
		var RequireWarning = false;
		$.each(thisDialog.find('li[id^=COL_]'),function(idx,thisDom){
			var thisDom = $(thisDom);
			var thisID = thisDom.data('id');
			var thisType = thisDom.data('type');
			var thisItem = column_object[thisID];
			
			switch(thisType){
				case 'inputbox':
				case 'areabox':
				case 'list':
				case "subquery":
				case "date":
				case "datetime":
					var thisValue=thisDom.find('[name=setValue]:eq(0)').val();
					if(thisDom.find('font[color=red]').length && (null==thisValue || thisValue.length==0))
						RequireWarning = true;
					else{
						var item_data = {};
						item_data['id'] = thisID;
						item_data['value'] = thisValue;
						item_data['type'] = thisType;
						data.push(item_data);
					}
					break;
				case 'checkbox':
					//抓取值
					var thisValue=[];
					if(thisItem.config.multiple){
						thisValue= $('input[name="' + thisID + '"]:checked').map(function() { return $(this).val(); }).get();
					}else{
						thisValue= [];
						if($('input[name="' + thisID + '"]:checked').length)
							thisValue.push($('input[name="' + thisID + '"]:checked').val());
					}
					//檢查必填
					if(thisDom.find('font[color=red]').length && thisValue.length==0 ){
						RequireWarning = true;
					}else{
						var item_data = {};
						item_data['id'] = thisID;
						item_data['type'] = thisType;
						item_data['value'] = thisValue;
						data.push(item_data);
					}
					break;
				case 'h_level':
					//抓取值
					var thisValue=thisDom.find('[name=setValue]:eq(0)').val();
					//檢查必填
					if(thisDom.find('font[color=red]').length && (null==thisValue || thisValue.length==0))
						RequireWarning = true;
					else{
						var item_data = {};
						item_data['id'] = thisID;
						item_data['value'] = thisValue;
						item_data['type'] = thisType;
						data.push(item_data);
						//
						var header_item_data = {};
						header_item_data['id'] = 'level';
						header_item_data['value'] = item_data['value'];
						header_item_data['type'] = 'header';
						data.push(header_item_data);
					}
					break;
				case 'h_title':
					//抓取值
					var thisValue=thisDom.find('[name=setValue]:eq(0)').val();
					//檢查必填
					if(thisDom.find('font[color=red]').length && (null==thisValue || thisValue.length==0))
						RequireWarning = true;
					else{
						var item_data = {};
						item_data['id'] = thisID;
						item_data['value'] = thisValue;
						item_data['type'] = thisType;
						data.push(item_data);
						//
						var header_item_data = {};
						header_item_data['id'] = 'title';
						header_item_data['value'] = thisValue;
						header_item_data['type'] = 'header';
						data.push(header_item_data);
					}
					break;
				case 'h_status':
					//抓取值
					var thisValue=thisDom.find('[name=setValue]:eq(0)').val();
					var thisText=thisDom.find('[name=setValue]:eq(0) :selected').text();
					//檢查必填
					if(thisDom.find('font[color=red]').length && (null==thisValue || thisValue.length==0))
						RequireWarning = true;
					else{
						var item_data = {};
						item_data['id'] = thisID;
						item_data['value'] = thisValue;
						item_data['type'] = thisType;
						data.push(item_data);
						//
						var header_item_data = {};
						header_item_data['id'] = 'status';
						header_item_data['value'] = thisText;
						header_item_data['type'] = 'header';
						data.push(header_item_data);
					}
					break;
				case 'h_group':
					//抓取值
					var thisValue1=thisDom.find('[name=setValue1]:eq(0)').val();
					var thisValue2=thisDom.find('[name=setValue2]:eq(0)').val();
					//檢查必填
					if( 
						thisDom.find('label:eq(0) font[color=red]').length && (null==thisValue1 || thisValue1.length==0 ) ||
						thisDom.find('label:eq(1) font[color=red]').length && (null==thisValue2 || thisValue2.length==0 )
					)
						RequireWarning = true;
					else{
						var item_data = {};
						item_data['id'] = thisID;
						item_data['value'] = {'group':thisValue1,'user':thisValue2};
						item_data['type'] = thisType;
						data.push(item_data);
						var header_item_data = {};
						header_item_data['id'] = 'group';
						header_item_data['value'] = item_data['value'];
						header_item_data['type'] = 'header';
						data.push(header_item_data);
					}
					break;
				case 'file':
					if(thisDom.find('font[color=red]').length && thisDom.find('.mailbox-attachment-name').length)
						RequireWarning = true;
					break;
			}
			
			if(RequireWarning)
				return false;
		});
		
		if(RequireWarning)
			return false;
		else
			return data;
	}
	
	//送出服務需求
	function Request_Send(){
		var thisDialog = $('#service-grid-config');
		var api_path = box_object.list[thisDialog.attr('name')].api_path;

		var data = getFormdata(thisDialog.find("#tab-step"));
		
		if( typeof(data.length)=="undefined" && data==false){
			thisDialog.off('hidden.bs.modal');
			thisDialog.on('hidden.bs.modal', function () {
				thisDialog.off('hidden.bs.modal');
			    var callback = function(){
			    	thatDialog = $("#modal_yellow");
			    	thatDialog.off('hidden.bs.modal');
					thatDialog.on('hidden.bs.modal', function () {
						thatDialog.off('hidden.bs.modal');
						$('#service-grid-config').modal('show');
					});
			    };
			    omflowAlert('yellow', const_lack_require, callback);
			});
			thisDialog.modal('hide');
			return;
		}
		//omflowJsonAjax(postbody, '{% url "requestAjax"%}', callback);
		
		var form_data = new FormData();
		var url = '{% url "requestAjax"%}';
		form_data.append("csrfmiddlewaretoken", '{{ csrf_token }}');
		form_data.append("api_path", api_path);
		form_data.append("service_id", thisDialog.attr('name'));
		form_data.append("formdata", JSON.stringify(data));
		for (var i = 0, len = filesToUpload.length; i < len; i++) {
			form_data.append("files", filesToUpload[i].file);
		}
		$.ajax({
			url: url,
			type: 'post',
			data: form_data,
			cache:false,
			processData: false,
			contentType: false,
			dataType: 'json',
			xhr : function () {
				var myXhr = $.ajaxSettings.xhr();
				if(myXhr.upload){
					myXhr.upload.addEventListener('progress',progressHandlingFunction, false);
					return myXhr;
				}
			},
			success: function (data) {
				//$('button[name="file_upload"]').hide();
				$("#modal-progress").modal("hide");
				$('#attach_upload').empty();
				fileIdCounter = 0;
				filesToUpload = [];
				fileTotalSize = 0;
				//attachment_browser();
				actions(data,"{% trans '請求成功'%}");
			},
			error: function(req, status, err) {
				$('#modal_error').modal('show');
				console.log('Something went wrong', status, err);
			}
		});
		
		function progressHandle()
		{
			var value = (event.loaded / event.total * 100 | 0);
			var strProgress = value + "%";
			$("#modal_attachment_browser .progress-bar").css({"width": strProgress});
			$("#modal_attachment_browser .progress-bar").text(strProgress);
		}
		thisDialog.modal('hide');
	}
	
	//儲存服務需求設定
	function Service_save(){
		var thisDialog = $('#service-grid-config');
		var item_id = thisDialog.attr('name');
		var item = box_object.list[item_id];
		
		//一般設定
		Grid_submit("service");
		
		item.service.tree = [];
		item.service.list = {};
		var data = getFormdata(thisDialog.find("#tab-default"));
		if( typeof(data.length)=="undefined" && data==false){
			thisDialog.off('hidden.bs.modal');
			thisDialog.on('hidden.bs.modal', function () {
				thisDialog.off('hidden.bs.modal');
			    var callback = function(){
			    	thatDialog = $("#modal_yellow");
			    	thatDialog.off('hidden.bs.modal');
					thatDialog.on('hidden.bs.modal', function () {
						thatDialog.off('hidden.bs.modal');
						$('#service-grid-config').modal('show');
					});
			    };
			    omflowAlert('yellow', const_lack_require, callback);
			});
			thisDialog.modal('hide');
			return;
		}
		item.default_value = data;
		
		//儲存步驟設定
		$.each(thisDialog.find(".tablinks"),function(idx,thisTab){
			var thisTab = $(thisTab);
			var thisStep = {
					name:thisTab.find('input').val(),
					column_list:[],
					tip:""
				};
			var step_id = thisTab.data('step');
			var thisContent = thisDialog.find('.tabcontent[data-step='+step_id+']');
			thisStep.tip = thisContent.find('.syscom-tip').val();
			//thisStep.rows = thisContent.find('.syscom-tip')[0].rows+1;
			$.each(thisContent.find('li[id^=COL_]'),function(idx,thisCol){
				thisStep.column_list.push($(thisCol).data('id'));
			});
			
			item.service.tree.push(step_id);
			item.service.list[step_id]=thisStep;
		});
		
		//儲存預設值
		//var column_list = [];
		//$.each(thisDialog.find(".tabcontent[data-step=default] [id^=COL_]"),function(idx,thisCol){
			//thisCol_obj = {};
			//thisFormCol = column_object[thisCol.id];
			//column_list.push($(thisCol).data('id'));
		//});
		//item["default_value"]=column_list;
		
		thisDialog.modal('hide');
	}
	
	function Array_to_Option(thisItem){
		var options = ''
		$.each(thisItem.config.lists,function(idx,thisObj){
			options += '<option value="'+thisObj.value+'">'+thisObj.text+'</option>'
		});
		return options;
	}
	
	function Array_to_CheckBox(thisItem){
		var output = '';
		//var global_id = active_id + '_' + form_item.id;
		var multiple = thisItem.config.multiple;
		var readonly = '';
		if(thisItem.config.readonly)
		{
			readonly = 'readonly';
		}
		
		thisItem.config.lists.forEach(function(item, index, array)
		{
			if(multiple)
			{
				//checkbox  
				output += '<div><input id="' + thisItem.id + '_' + index + '" name="' + thisItem.id + '" type="checkbox" class="icheckbox_minimal-blue" value="' + item.value + '" '+readonly+'><label for="' + thisItem.id + '_' + index + '"></label>' + item.text + '</div>'
			}
			else
			{
				//radio
				output += '<div><input id="' + thisItem.id + '_' + index + '" name="' + thisItem.id + '" type="radio" class="iradio_minimal-blue" value="' + item.value + '" '+readonly+'><label for="' + thisItem.id + '_' + index + '"></label>' + item.text + '</div>'
			}
				
		});
		
		return output;
	}
	
	//讀取組織清單
	function GroupArray_to_Option(){
		var output = '';
		$.ajax({
			url	: '{% url 'listGroupAjax' %}',
			type: 'post',
			headers: { "X-CSRFToken": csrfmiddlewaretoken },
	        data: JSON.stringify({}),
	        async:false,
	        dataType: 'json',
	        success: function (data) {
	            var group_tree_data_uuid = [];
				var list_count = 0;
				var uuid_mode = false;
				//get global
				if(group_tree_data_uuid.length <= 0 ){
				
					var group_tree_data_source = data.result;
					group_tree_data_source.forEach(function(option_item){
						if(option_item.parent_group == null){
							group_tree_data_uuid.push({'id':option_item.id ,'value':option_item.group_uuid ,'text':option_item.display_name ,'parent_group':option_item.parent_group ,'parent':null,'level':1,'nonleaf':'non-leaf'});
						}
						else{
							var new_class = 0;
							var parent_uuid = '';
							group_tree_data_uuid.forEach(function(parent_item){
								
								if(parent_item.id == option_item.parent_group){
									new_class = parent_item.level + 1;
									parent_uuid = parent_item.value;
								}
							});
							//find child
							var nonleaf = '';
							group_tree_data_source.forEach(function(find_item){
								if(find_item.parent_group == option_item.id){
									nonleaf = 'non-leaf';
								}
							});
							group_tree_data_uuid.push({'id':option_item.id ,'value':option_item.group_uuid ,'text':option_item.display_name ,'parent_group':option_item.parent_group ,'parent':parent_uuid,'level':new_class,'nonleaf':nonleaf });
						}
					});
				}
				
				if(list_count <= 0){//remake
					if(uuid_mode){
						group_tree_data_uuid.forEach(function(group_item){
							if (group_item.parent==null){
								output += '<option value="' + group_item.value + '" class="l' + group_item.level + ' ' + group_item.nonleaf + '" >' + group_item.text + '</option><!--' + group_item.value + '-->';
							}else{
								output = output.replace('<!--' + group_item.parent + '-->','<option value="' + group_item.value + '" data-pup="' + group_item.parent + '" class="l' + group_item.level + ' ' + group_item.nonleaf + '" >' + group_item.text + '</option><!--' + group_item.value + '--><!--' + group_item.parent + '-->'); 
							}
						});
					}else{//convert to id
						group_tree_data_uuid.forEach(function(group_item){
							if (group_item.parent==null){
								output += '<option value="' + group_item.id + '" class="l' + group_item.level + ' ' + group_item.nonleaf + '" >' + group_item.text + '</option><!--' + group_item.id + '-->';
							}else{
								output = output.replace('<!--' + group_item.parent_group + '-->','<option value="' + group_item.id + '" data-pup="' + group_item.parent_group + '" class="l' + group_item.level + ' ' + group_item.nonleaf + '" >' + group_item.text + '</option><!--' + group_item.id + '--><!--' + group_item.parent_group + '-->'); 
							}
						});	
					}
				}else{
					if(uuid_mode){
						group_tree_data_uuid.forEach(function(group_item){
							if (group_item.parent==null){
								output += '<option value="' + group_item.value + '" class="l' + group_item.level + ' ' + group_item.nonleaf + '" >' + group_item.text + '</option><!--' + group_item.value + '-->';
							}else{
								output = output.replace('<!--' + group_item.parent + '-->','<option value="' + group_item.value + '" data-pup="' + group_item.parent + '" class="l' + group_item.level + ' ' + group_item.nonleaf + '" >' + group_item.text + '</option><!--' + group_item.value + '--><!--' + group_item.parent + '-->'); 
							}
						});
					}else{
						//需支援多層次
						var output_multi = '';
						form_item.config.lists.forEach(function(list_item){
							output = '';
							var root_id = 0;
							var tree_item = [];
							group_tree_data_uuid.forEach(function(group_item){
								//循線往下長
								var root_level = 1;
								if (group_item.value == list_item.text){
									output += '<option value="' + group_item.id + '" class="l' + '1' + ' ' + group_item.nonleaf + '" >' + group_item.text + '</option><!--' + group_item.id + '-->';
									root_level = group_item.level;
									tree_item.push(group_item.id);
								}else{
									if((tree_item.indexOf(group_item.id))||(tree_item.indexOf(group_item.parent_group))){
										if(!(group_item.id in tree_item)){
											tree_item.push(group_item.id);
										}
										output = output.replace('<!--' + group_item.parent_group + '-->','<option value="' + group_item.id + '" data-pup="' + group_item.parent_group + '" class="l' + group_item.level + ' ' + group_item.nonleaf + '" >' + group_item.text + '</option><!--' + group_item.id + '--><!--' + group_item.parent_group + '-->'); 
									}
								}
							});	
							output_multi = output_multi + output;
						});
						output = output_multi;
					}
				}
			},
	        error: function(req, status, err) {
				$('#modal_error').modal('show');
	        	console.log('Something went wrong', status, err);
	    	}
		});
		
		return output;
	}
	
	//讀取組織人員清單
	function GroupUserArray_to_Option(group_id){
		if(!group_id)
			return "";
		var userlist = '<option value="">'+const_none_user+'</option>';
		$.ajax({
			url: "{% url 'searchGroupUserAjax' %}",
			type: 'post',
			headers: { "X-CSRFToken": csrfmiddlewaretoken },
			data: JSON.stringify({ searchkey: group_id }),
	        async:false,
			contentType: "application/json;charset=utf-8;",
			success: function (data) {
	            $.each(data.result,function(idx,thisObj){
	            	userlist += '<option value='+thisObj.id+'>'+thisObj.nick_name+'</option>';
	            });
			},
			error: function(req, status, err) {
				$('#modal_error').modal('show');
	        	console.log('Something went wrong', status, err);
	    	}
		});
		return userlist;
	}
	
	//
	function RoleArray_to_Option(){
		var rolelist = '<option value=-1>'+const_all_people+'</option>';
		$.ajax({
			url: "{% url 'listGroupAjax' %}",
			type: 'post',
			headers: { "X-CSRFToken": csrfmiddlewaretoken },
			data: JSON.stringify({ functional_flag: 1 }),
			async:false,
			contentType: "application/json;charset=utf-8;",
			success: function (data) {
	            $.each(data.result,function(idx,thisObj){
	            	rolelist += '<option value='+thisObj.id+'>'+thisObj.display_name+'</option>';
	            });
			},
			error: function(req, status, err) {
				$('#modal_error').modal('show');
	        	console.log('Something went wrong', status, err);
	    	}
		});
		return rolelist;
	}
	
	function BindSwitchModal(thisModal,nextModal){
		thisModal = $(thisModal);
		nextModal = $(nextModal);
		thisModal.off('hidden.bs.modal');
		thisModal.on('hidden.bs.modal', function () {
			thisModal.off('hidden.bs.modal');
		    nextModal.modal('show');
		});
	}
	
	//Listener
    //改變選項顏色
    $('body').on('change','select[name="setColor"]',function(){
    	var thisColor = $(this).find('option[value="'+$(this).val()+'"]').data('color');
    	$(this).closest('td').find('[name="showColor"]').css(
    		{
	    		'background-color':thisColor,
	    		border:thisColor,
	    		color:"white"
    		}
    	);
    });
    //改變Icon
    $('body').on('change','select[name="setIcon"]',function(){
    	var thisIcon = $(this).find('option[value="'+$(this).val()+'"]').data('value');
    	$(this).closest('td').find('[name="showIcon"]').val(thisIcon);
    });
    
    //上傳檔案
    var fileIdCounter = 0;
	var filesToUpload = [];
	var fileTotalSize = 0;
	
	function remove_upload(th,item)
	{
		
		for (var i = 0; i < filesToUpload.length; ++i) {
			if (filesToUpload[i].id === item)
				filesToUpload.splice(i, 1);
		}
		$(th).closest('li').remove();
		if (filesToUpload.length != 0)
			{check_disk();}
		//else
			//{$('button[name="file_upload"]').hide();}
	}
	
	//匯出服務
	function flowapp_output(){
		omflowListDialogue('output', "{% trans '匯出所有服務請求' %}", output_confirm);
		//產生
		var makeTextFile = function (text) {
            var data = new Blob([text], {
                type: 'text/plain'
            });

            // If we are replacing a previously generated file we need to
            // manually revoke the object URL to avoid memory leaks.
            if (textFile !== null) {
                window.URL.revokeObjectURL(textFile);
            }
            textFile = window.URL.createObjectURL(data);

            return textFile;
        };
        
        //產生檔名
        var NowDate = new Date();
		var Y = NowDate.getYear()+1900;
		var M = NowDate.getMonth()+1;
		var d = NowDate.getDate();
		var h = NowDate.getHours();
		var m = NowDate.getMinutes();
		var s = NowDate.getSeconds();
        var filename = "OMFLOW-SERVICE_"+Y+"-"+M+"-"+d+"_"+h+"-"+m+"-"+s+".oms";
		$('#modal-default-list-text').append('<li class="list-group-item"><div class="mailbox-attachment-info">'+
			        	'<p class="mailbox-attachment-name" style="word-break: break-all;"><i class="fa fa-paperclip"></i>&nbsp;&nbsp;'+filename+'</p>'+
			            '<span class="mailbox-attachment-size"></span>'+
			      		'</div></li>')
		
		var app_id_list =[];
		$('.table input:checkbox:checked').each(function(){
			app_id_list.push($(this).attr('id'));
		});
		
		var postbody = {app_id_list: app_id_list};
		omflowJsonAjax(postbody, "{% url 'exportServcieAjax'%}", actions);
		
		function actions(data)
		{	
			$('body').append($('<a id="exporta" href="'+makeTextFile(JSON.stringify(data.result))+'" download="'+filename+'" style="display:none;"></a>'));
		}
		
		function output_confirm()
		{
			$('#exporta')[0].click();
			$('#exporta').remove();
		}
	}
	
	//選擇檔案-匯入服務請求
	function service_inputFile(files) {
	    if (files.length) {
	        var file = files[0];
	        var reader = new FileReader();
	        reader.onload = function(event) {
	        	$('#service_input_name').empty().append('<li style="width:100%;"><div class="mailbox-attachment-info">'+
				        	'<p class="mailbox-attachment-name" style="word-break: break-all;"><i class="fa fa-paperclip"></i>&nbsp;&nbsp;'+file.name+'</p>'+
				            '<span class="mailbox-attachment-size">'+omflowSizeUnit(file.size)+'</span>'+
				      		'</div></li>')
				$('#modal-service_input').modal('show');
				input_file = reader.result;
	        }
	            reader.readAsText(file);
	            
        }
    }
    
    //匯入服務請求
    function service_inputSave(){
    	input_file = JSON.parse(input_file);
		if( input_file.box_object ){
			//重新導入box_object
			box_object = input_file.box_object;
			try{
				$("#ServiceList").empty();
				$("#ServiceRoot").empty();
				ServiceRoot_build();
				
				//設定lan_package
				if( input_file.lan_package )
					lan_package = input_file.lan_package;
				
				$('#file').val('');
		    	SweetAlert('success','{% trans '成功'%}');
			    
			}catch(e){
				$("#ServiceList").empty();
				$("#ServiceRoot").empty();
				box_object = {};
                box_object["index"] = 1;
                box_object["list"] = {};
                box_object["tree"] = {0:[]};
                box_object["sort"] = [0];
                ServiceRoot_build();
                SweetAlert('error','{% trans '資料格式不符'%}');
			}
		}else{
	    	SweetAlert('error','{% trans '資料格式不符'%}');
		}
    }
	
	//翻譯
	function app_translate()
	{
		$('#modal-app_translate').modal('show');
	}
	//匯出翻譯
	function translate_output()
	{
		var postdata = {
			language:	$('#language-select').val()
		}
		omflowJsonAjax(postdata, '{% url 'exportTranslationAjax'%}', output_action)
		
		function output_action(data)
		{
			if (data.status == 200)
			{
				omflowListDialogue('output', "{% trans '匯出翻譯包' %}", output_confirm);
				var Data = data.result
				var makeTextFile = function(Data) {
					if (window.Blob && window.URL && window.URL.createObjectURL) {
						var text = new Blob([Data], {
							type: 'text/plain;charset=utf-8;'
						});
						return URL.createObjectURL(text);
					}
				}
				
				//產生檔名
		        var NowDate = new Date();
				var Y = NowDate.getYear()+1900;
				var M = NowDate.getMonth()+1;
				var d = NowDate.getDate();
				var h = NowDate.getHours();
				var m = NowDate.getMinutes();
				var s = NowDate.getSeconds();
				var tlang = $('#language-select').val();
		        var filename = "OMFLOW-SERVICE_Translate Into_"+tlang+"-"+Y+"-"+M+"-"+d+"_"+h+"-"+m+"-"+s+".txt";
				$('#modal-default-list-text').append('<li class="list-group-item"><div class="mailbox-attachment-info">'+
					        	'<p class="mailbox-attachment-name" style="word-break: break-all;"><i class="fa fa-paperclip"></i>&nbsp;&nbsp;'+filename+'</p>'+
					            '<span class="mailbox-attachment-size"></span>'+
					      		'</div></li>')
				
				$('body').append($('<a id="exporta" href="'+makeTextFile(Data)+'" download="'+filename+'" style="display:none;"></a>'));
				
				function output_confirm()
				{
					$('#exporta')[0].click();
					$('#exporta').remove();
				}
			}
			else
			{
				actions(data)
			}
		}
	}
	
	//匯入翻譯
	function input_confirm()
    {
    	var postdata ={
    		language:	$('#language-select').val(),
    		language_list: input_file
    	}
    	omflowJsonAjax(postdata, '{% url "importTranslationAjax"%}', actions)
    }
	
	function translate_input(files)
	{
		omflowListDialogue('input', "{% trans '匯入翻譯包' %}", input_confirm);
		if (files.length) {
	        var file = files[0];
	        var reader = new FileReader();
	        reader.onload = function(event) {
	        	$('#modal-default-list-text').append('<li class="list-group-item"><div class="mailbox-attachment-info">'+
			        	'<p class="mailbox-attachment-name" style="word-break: break-all;"><i class="fa fa-paperclip"></i>&nbsp;&nbsp;'+file.name+'</p>'+
			            '<span class="mailbox-attachment-size">'+omflowSizeUnit(file.size)+'</span>'+
			      		'</div></li>')
				input_file = reader.result;
	        }
	        reader.readAsText(file);
        }
	}
	
	//檢查Server硬碟空間
	function check_disk()
	{
		var postbody = { file_size: fileTotalSize };
		omflowJsonAjax(postbody, '{% url "getDiskStatusAjax" %}', actions_upload)
		
		function actions_upload(data){
			if (data.result)
			{
				$('label[name="fileWarning"]').hide();
				//$('button[name="file_upload"]').show();
			} 
			else
			{
				$('label[name="fileWarning"]').show();
				//$('button[name="file_upload"]').hide();
			}
		}
	}
    
    //SweetAlert
    function SweetAlert(){
    	Swal.fire({
			icon : arguments[0],
			title: arguments[1],
			toast: true,
			position: 'bottom-start',
			showConfirmButton: false,
			timer: 2000,
	    });
    }
    
    //改變欄位
    //drop、drag
	function boxdrag(ev){
	    ev.dataTransfer.setData("boxid", ev.target.id);
	}
	function boxdrop(ev, target_object){
	    ev.preventDefault();
	    ev.stopPropagation();
	    
	    var target = $('#'+target_object.id);
	    var source = $('#'+ev.dataTransfer.getData("boxid"));
        if(target != source){
        	if(target.is('li') && source.is('div')){
		        box_move_item(box_object.list[source.data('idx')],target.data('idx'));
				SweetAlert('success','{% trans '成功'%}');
			}else if(target.is('div') && source.is('div') || target.is('li') && source.is('li')){
				var targetSpot = $('<span></span>');
				var sourceSpot = $('<span></span>');
				targetSpot.insertBefore(target);
				sourceSpot.insertBefore(source);
				target.insertBefore(sourceSpot);
				source.insertBefore(targetSpot);
				targetSpot.remove();
				sourceSpot.remove();
			}
		}
	    setTree();
	}
	function boxAllowDrop(ev){
	    ev.preventDefault();
	}
	
	//----------------------------------------------------------
	
	
	//子查詢動作
	function SubQuery(){
		var form_item = column_object[arguments[0]];
		var active_id = 'formcontent';
		var baseID_SUBQUERY_TABLE = active_id + '_' + 'subquery_table_modal'; 
		
		//取得顯示欄位，組合成datatable 格式
		var displayfield = {}
		var table_column = [];
		var omdata_ajax_var = {url:'{% url 'SubQueryHeaderAjax'%}',service_id:'{{flow_uuid}}'};
		
		if(table != undefined)
		{
			table.clear();
			table.destroy();
			$('#' + baseID_SUBQUERY_TABLE + '_datatable thead tr').html('');
		}
		
		
		if(event_get_display_field_load_callback == null)
		{
			
		}
		else
		{
			displayfield = event_get_display_field_load_callback(form_item.config.app_name, form_item.config.flow_name);
		}
		$('#' + baseID_SUBQUERY_TABLE + '_datatable thead tr').append('<th></th>');
		table_column.push({"data": "id", "width": "15px", "orderable": false, "render": function(data, type, row)
			{return '<input type="radio" class="iradio_minimal-blue" name="'+ form_item.id +'_radio" value="'+data+'" data-no="'+row.data_no+'" id="'+ form_item.id +'_omdata_'+data+'"><label for="'+ form_item.id +'_omdata_'+data+'"></label>'}
		});
		
		$.each(displayfield, function(index, value){
			$('#' + baseID_SUBQUERY_TABLE + '_datatable thead tr').append('<th>'+value+'</th>');
			if(index == 'data_no')
			{
				table_column.push({"data": index, "render": function(data)
					{	
						return paddingLeft(data,8)
					}	
				});
			}
			else if(index == 'error')
			{	
				table_column.push({"data": index, "render": function(data)
					{
						if(data)
						{return '<div class="label label-danger">'+gettext('異常')+'</div>'}
						else
						{return '<div class="label label-success">'+gettext('正常')+'</div>'}
					}
				});
			}
			else if(index == 'level')
			{	
				table_column.push({"data": index, "render": function(data)
					{
						if(data == 'yellow')
							{return '<div class="label label-warning">'+gettext('黃燈')+'</div>'}
						else if(data == 'red')
							{return '<div class="label label-danger">'+gettext('紅燈')+'</div>'}
						else
							{return '<div class="label label-success">'+gettext('綠燈')+'</div>'}		
					}
				});
			}
			else if(index == 'updatetime')
			{
				table_column.push({"data": index, "render": function(data)
					{
						if(data)
							{return data.slice(0,-7)}
						else
							{return data}
					}
				});
			}
			else if(index.indexOf('-group') > 0)
			{
				table_column.push({"data": 'group', "render": function(data)
					{
						data = JSON.parse(unescapeHtml(data));
						if(data)
							{return data.group}
						else
							{return ''}
					}
				});
			}
			else if(index.indexOf('-user') > 0)
			{
				table_column.push({"data": 'group', "render": function(data)
					{
						data = JSON.parse(unescapeHtml(data));
						if(data)
							{return data.user}
						else
							{return ''}
					}
				});
			}
			else
			{
				table_column.push({"data": index});
			}
		});
		
		table = $('#' + baseID_SUBQUERY_TABLE + '_datatable').DataTable({
			"autoWidth"	: true,
			"order"		: [[ 1, "desc" ]], 					//	default order column[1]
			"serverSide": true,							//	serverside data loading
			"dom"		:"<<t>'row'<'row'<'col-sm-5'i><'col-sm-7'p>>>",
			"scrollX": true,
			"language"	: __const_language__,
			"ajax": {
				"url": omdata_ajax_var.url,
		    	"type": "POST",
		    	"headers": { "X-CSRFToken": getCookie("csrftoken") },
				"contentType": "application/json;charset=utf-8;",
		    	"data":	function ( d ) {
							return JSON.stringify($.extend( {}, d, {
						        app_name	: form_item.config.app_name,
						       	flow_name	: form_item.config.flow_name,
						        condition	: form_item.config.rule,
						        service_id	: omdata_ajax_var.service_id
						    }));
						},
				"dataSrc": function(data){
					a = dataCompare(data,data_tmp,data_len,data_page,table);
					data_tmp = a['data_tmp']
					data_len = a['data_len']
					data_page = a['data_page']
					data.data = a['data.data']
					return data.data;
				},
			},
        	"columns":	table_column
		});
		$('#' + baseID_SUBQUERY_TABLE).modal('show');
		$('#' + baseID_SUBQUERY_TABLE + '_submit').off('click').click(function() 
		{
			modal_subquery_submit(baseID_SUBQUERY_TABLE, form_item);
		});
		$('#' + baseID_SUBQUERY_TABLE + '_close').click(function() 
		{
			$('#' + baseID_SUBQUERY_TABLE ).modal('hide');
		});
	}
	var event_get_display_field_load_callback = function(app_name, flow_name)
	{
		var displayfield = {};
		var postbody = {'app_name': app_name, 'flow_name': flow_name};
		$.ajax({
			url: "{% url 'getFlowActiveDisplayFieldAjax' %}",
			type: 'post',
			headers: { "X-CSRFToken": csrfmiddlewaretoken },
			data: JSON.stringify(postbody),
			async:false,
			dataType: 'json',
			contentType: "application/json;charset=utf-8;",
			success: function (data) {
				displayfield = JSON.parse(data.result.display_field)
			},
			error: function(req, status, err) {
				$('#modal_error').modal('show');
	        	console.log('Something went wrong', status, err);
	    	}
		});
		
		return displayfield;
	}
	var event_get_omdata_load_callback = function(app_name, flow_name, data_id, fields, service_id)
	{
		var omdata_value = {};
		var postbody =  {
					        app_name			: app_name,
					       	flow_name			: flow_name,
					        data_id				: data_id,
					        fields				: fields,
					       	service_id			: service_id
					    };
		$.ajax({
			url: "{% url 'SubQueryDataAjax' %}",
			type: 'post',
			headers: { "X-CSRFToken": csrfmiddlewaretoken },
			data: JSON.stringify(postbody),
			async:false,
			dataType: 'json',
			contentType: "application/json;charset=utf-8;",
			success: function (data) {
				omdata_value = data.result
			},
			error: function(req, status, err) {
				$('#modal_error').modal('show');
	        	console.log('Something went wrong', status, err);
	    	}
		});
		
		return omdata_value;
	}
	
	function modal_subquery_submit(baseID, item)
	{
		if($('#' + baseID + '_datatable input:radio:checked').length != 1)
		{
			
		}
		else
		{
			var omdata_value = [];
			if(event_get_omdata_load_callback == null)
			{
				
			}
			else
			{
				var data_id = $('#' + baseID + '_datatable input:radio:checked').val();
				var fields = [];
				item.config.fill.forEach(function(fill_item, index)
				{
					fields.push(fill_item.column)
				})
				omdata_value = event_get_omdata_load_callback(item.config.app_name, item.config.flow_name, data_id, fields)
			}
			
			item.config.fill.forEach(function(fill_item, index)
			{
				var type = '';
				var target = '';
				if(fill_item.target.startsWith('#('))
				{
					target = fill_item.target.slice(2,-1);
					type = $('#formcontent_' + target + '_item:eq(0)').prop('localName');
				}
				else if(fill_item.target.startsWith('#G1('))
				{
					target = fill_item.target.slice(4,-1) + '_group';
					type = 'select';
				}
				else if(fill_item.target.startsWith('#G2('))
				{
					target = fill_item.target.slice(4,-1) + '_user';
					type = 'select';
				}
				//console.log(type)
				if(type == 'select')
				{
					//console.log(omdata_value)
					$('#formcontent_' + target + '_item').val(omdata_value[fill_item.column]).trigger('change');
				}
				else if(type == 'div')
				{
					$.each($('#formcontent_' + target + '_item input'), function()
					{
						if($(this).val() == omdata_value[fill_item.column])
						{
							$(this).prop('checked', true);
						}else{
							$(this).prop('checked', false);
						}
					})
				}
				else
				{
					$('#formcontent_' + target + '_item').val(omdata_value[fill_item.column]);
				}
			})
		}
		$('#' + baseID).modal('hide')
	}
    </script>
{% endblock %}