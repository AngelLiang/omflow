{% extends 'base.html' %}
{% load static %}
{% load i18n %} 
{% block content %}
<!-- 
	flow_design.html flowdesignPage
	author : Pei lin
-->
    <!-- Content Header (Page header) -->
    <script src="/static/js/workflow.js"></script>
    <section class="content-header">
      <h1>
      	
        <small></small>
      </h1>
      <ol class="breadcrumb">
        <li><a href="/"><i class="fa fa-dashboard"></i> {% trans '首頁'%}</a></li>
		
      </ol>
    </section>
    
    <!-- Main content -->
    <section class="content">
      <div class="row">
        <div class="col-xs-12">
          <div class="box box-primary">
          	<div class="box-header with-border">
          	  <button type="button" class="btn btn-default" onclick="updateOmdata()" style="margin:1px 0px;"><i class="fa fa-paper-plane"></i> {% trans '送出'%}</button>
          	  <button type="button" class="btn btn-default" onclick="history_browser()" id="history" style="margin:1px 0px;display:none;"><i class="fa fa-history"></i> {% trans '歷程'%}</button>
{#          	  <button type="button" class="btn btn-default" onclick="relation_browser()" id="relation" style="margin:1px 0px;"><i class="fa fa-cogs"></i> {% trans '關聯'%}</button>#}
          	  <button type="button" class="btn btn-default" onclick="fp_show_browser()" id="fp_show" style="margin:1px 0px;display:none;"><i class="fa fa-stack-overflow"></i> {% trans '流程檢視'%}</button>
          	  <button type="button" class="btn btn-default" onclick="attachment_browser()" id="attachment" style="margin:1px 0px;display:none;"><i class="fas fa-file-archive"></i> {% trans '附加檔案'%}</button>
{#          	  <button type="button" class="btn btn-default" onclick="worklog_browser()" id="worklog" style="margin:1px 0px;"><i class="far fa-calendar-alt"></i> {% trans '工作日誌'%}</button>#}
			 <div class="pull-right">
			 </div>
          	</div>
          	<div class="box-body">
          	  <div class="row">
          	  	<div class="col-xs-12">
          	  	  <div id="formcontent"></div>
          	  	</div>
          	  </div>
          	</div>
          </div>
        </div>
        <div class="col-xs-3">
        </div>
        <div class="col-xs-12">
        </div>
      </div>
    </section>
    
    
    <div class="modal fade" id="modal_flow_browser" data-backdrop="static">
      <div class="modal-dialog" style="width:90%;">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title"></h4>
          </div>
          <div class="modal-body" >
            <div class="container-fluid">
              <div class="row">
              	<div class="col-md-8">
              	  <div id="flowcontent" style="width:100%;height:430px"></div>
              	</div>
              	<div class="col-md-4">
	              <table id="flow_history_table" class="table table-striped table-bordered table-hover">
	              	<col width="50%"></col>
	              	<col width="35%"></col>
	              	<col width="15%"></col>
				   	<thead>
				      <tr>
				      	<th>時間</th>
				      	<th>關卡名稱</th>
				      	<th></th>
				      </tr>
				    </thead>
				    <tbody>
				    </tbody>
				  </table>
              	</div>
              </div>
            </div>   
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary pull-right" data-dismiss="modal">{% trans '關閉' %}</button>
          </div>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->
    
    
    <div class="modal fade" id="modal-inoutput" data-backdrop="static">
	  <div class="modal-dialog modal-lg">
		<div class="modal-content">
		  <div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-label="Close">
			  <span aria-hidden="true">&times;</span></button>
			<h4 class="modal-title"><i class="fa fa-edit"></i>&nbsp;&nbsp;輸入/輸出</h4>
		  </div>
		  <div class="modal-body">
		  	<div class="row">
		  	  <div class="col-xs-6">
		  	  	<label>輸入</label>
		  	  	<textarea row="9" id="input_text" style="width:100%;height:300px;resize:none;"></textarea>
		  	  </div>
		  	  <div class="col-xs-6">
		  	  	<label>輸出</label>
		  	  	<textarea row="9" id="output_text" style="width:100%;height:300px;resize:none;"></textarea>
		  	  </div>
		  	</div>
		  </div>
		  <div class="modal-footer">
			<button type="button" id="modal-inoutput-close"  class="btn btn-primary" data-dismiss="modal">關閉</button>
		  </div>
		</div>
	  </div><!-- /.modal-content -->
	</div> 
    
    
    <div class="modal fade" id="modal_attachment_browser" data-backdrop="static">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title"><i class="fas fa-file-archive"></i>&nbsp;&nbsp;{% trans '附加檔案'%}</h4>
          </div>
          <div class="modal-header">
          	<div class="input-group">
			  <span class="input-group-addon"><i class="fa fa-search"></i></span>
			  <input type="text" id="attachment_search" name="search" class="form-control" placeholder=" {% trans '搜尋...'%}" onKeyup="attachment_search(this.value)" autofocus  />
		  	</div>
          </div>
          <div class="modal-body">
          	<ul class="list-group list-group-unbordered">
			  <li class="list-group-item">
			  	<div class="form-group">
		          <div class="btn btn-default btn-file">
		            <i class="fa fa-plus"></i> {% trans '新增檔案'%}
		            <input type="file" class="file" id="attachment_input" name="attachment_input" multiple="multiple">
		          </div>
		          <button type="button" class="btn btn-default" name="file_upload" onclick="file_upload()" style="margin:1px 0px;display:none;"><i class="fas fa-file-upload"></i> {% trans '上傳'%}</button>
		          <label name="fileWarning" class="text-red" style="display:none;">※※※{% trans '硬碟容量不足，請移除部分檔案再上傳或聯絡系統管理員'%}※※※</label>
		          <label name="uploadWarning" class="text-red" style="display:none;">※※※{% trans '檔案上傳中，請勿離開此頁面'%}※※※</label>
		        </div>
		        <ul class="mailbox-attachments clearfix" id="attach_upload">
		      	</ul>
		      	<div class="progress" style="display:none;">
		          <div class="progress-bar" role="progressbar" style="width:0%;">0%</div>
		        </div>
			  </li>
			  <li class="list-group-item">
			  	<label class="text-light-blue">{% trans '已上傳檔案'%}</label>
			  	<ul class="mailbox-attachments clearfix" id="attach_list">
          		</ul>
			  </li>
			</ul>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary pull-right" data-dismiss="modal">{% trans '關閉' %}</button>
          </div>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->
    
    
    <div class="modal fade" id="modal_omdata_history" data-backdrop="static">
      <div class="modal-dialog" style="width:90%;">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title"></h4>
          </div>
          <div class="modal-body" >
          	<div class="container-fluid">
              <div class="row">
              	<div class="col-md-8">
              	  <div id="omdata_history_formcontent"></div>
              	</div>
              	<div class="col-md-4">
              	  <table id="omdata_history_table" class="table table-striped table-bordered table-hover">
				   	<thead>
				      <tr>
				      	<th>是否異常</th>
				      	<th>填表人</th>
				      	<th>更新日期</th>
				      </tr>
				    </thead>
				    <tbody>
				    </tbody>
				  </table>
              	</div>
              </div>
            </div> 
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary pull-right" data-dismiss="modal">{% trans '關閉' %}</button>
          </div>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->
    
    <style>
		table td {
			max-width: 120px;
			white-space: nowrap;
			text-overflow: ellipsis;
			word-break: break-all;
			overflow: hidden;
			}
		table tr{
			cursor:pointer;
		}
		.btn.btn-file:disabled{
			cursor:not-allowed;
		}
		.btn.btn-file > input[type="file"]:disabled{
			cursor:not-allowed;
		}
	</style>
    
    <script>
    var csrfmiddlewaretoken="{{ csrf_token }}";
	var formcontent = new omformeng('formcontent');
	var flowcontent = new omfloweng('flowcontent');
	var inoutputdata = {};
	var omdata_history_formcontent = new omformeng('omdata_history_formcontent');
	var fileIdCounter = 0;
	var filesToUpload = [];
	var fileTotalSize = 0;
	var url = window.location.pathname;
	flowcontent.init(false);
	omdata_history_formcontent.init(false);
	flowcontent.event_chart_selected(flow_history_select);
	
    $(function(){
    	readform('{{data_id}}');
	    
	    $('#attachment_input').change(function(evt){
	    	var output = [];
	    	
	    	for (var i = 0; i < evt.target.files.length; i++) {
	            fileIdCounter++;
	            var file = evt.target.files[i];
	            var fileId = fileIdCounter;
	            var file_size = omflowSizeUnit(file.size);
				
				fileTotalSize += Math.ceil(file.size/Math.pow(2, 20));
	            filesToUpload.push({
	                id: fileId,
	                file: file
	            });
	            
	            output.push('<li><div class="mailbox-attachment-info">'
		        	+'<p class="mailbox-attachment-name" style="word-break: break-all;"><i class="fa fa-paperclip"></i>&nbsp;&nbsp;'+file.name+'</p>'
		            +'<span class="mailbox-attachment-size">'+file_size
		            +'<button type="button" class="close pull-right" name="remove_upload" onclick="remove_upload(this,'+fileId+')">'
		            +'<span aria-hidden="true">&times;</span></button></span>'
		      		+'</div></li>');
	        }
	    	
	    	$('#attach_upload').append(output.join(""));
		      
	      	evt.target.value = null;
	    	check_disk();
			
		});	
    });
    
    
	function flow_history_select(id, type)
	{
		$('#flow_history_table tbody tr').removeClass('selected');
		$('#flow_history_table tbody tr[data-value="'+id+'"]').addClass('selected');
	}
	
	var level_now = 1; 
	var flow_map = ''
    function fp_show_browser(){
    	var postdata = { 
    			csrfmiddlewaretoken: csrfmiddlewaretoken,
    			flow_uuid: '{{flow_uuid}}',
    			data_no	 : '{{data_no}}',
    			data_id	 : '{{data_id}}',
    			flow_level	 : 1
    	}
    	omflowJsonAjax(postdata, '{% url "loadFlowObjectAjax" %}', callback)
    	
    	var flow_history_table = '';
    	function callback(data)
    	{
    		if (data.status == 200)
    		{
    			flow_map = '<a id="map_'+level_now+'" onclick="change_fp_show(\'{{flow_uuid}}\',{{data_no}},1,\'map_'+level_now+'\')">'+data.result.flow_name+'</a>';
    			$('#modal_flow_browser .modal-title h4 small').html(flow_map);
    			$('#flowcontent').empty();
    			$('#flow_history_table tbody').empty();
		      	flowcontent.load(data.result.flowobject);
		      	var flowobject = JSON.parse(data.result.flowobject)
		      	var count = data.result.inoutput.length;
		      	$.each(data.result.inoutput, function(index,value){
		      		var checkflow = '';
		      		if(value.stop_chart_type == 'subflow')
		      		{ 
		      			checkflow = ' <button class="btn btn-xs btn-default" onclick="change_fp_show(\'{{flow_uuid}}-'+value.subflow_uid+'\',{{data_no}},'+(level_now+1)+',\'next\')"><i class="fas fa-search"></i></button>'
		      		}
		      		else if (value.stop_chart_type == 'outflow' | value.stop_chart_type == 'inflow')
		      		{
		      			checkflow = ' <button class="btn btn-xs btn-default" onclick="change_fp_show(\''+value.outflow_uuid+'\',\''+value.outflow_data_no+'\',1,\'next\')"><i class="fas fa-search"></i></button>'
		      		}
		      		$('#flow_history_table tbody').append('<tr data-value="'+value.chart_id+'"><td>'+value.createtime.slice(0,-7)+'</td><td>'+value.stop_chart_text+'</td><td><button class="btn btn-xs btn-default" onclick="inoutput('+index+')">檢視</button>'+checkflow+'</td></tr>')
		      	});
		      	inoutputdata = data.result.inoutput;
		      	flow_history_table =  $('#flow_history_table').DataTable({"ordering": false, "info": false, "lengthChange": false, "paging": false,"searching": false,"language": __const_language__})
		      	$('#flow_history_table tbody').off('click').on( 'click', 'tr', function(){
		      		flowcontent.setFocus($(this).data('value'));
			    });
			    $('#modal_flow_browser').off('hidden.bs.modal').on('hidden.bs.modal', function(){
		    		flow_history_table.clear();
		    		flow_history_table.destroy();
		    	});
		    	$('#modal_flow_browser').off('shown.bs.modal').on('shown.bs.modal', function(){
		    		$('#flow_history_table tbody tr:last').trigger('click');
		    	});
		      	$('#modal_flow_browser').modal('show');
			}
			else
			{
				omflowAlert('red', data.message);
			}
    	}
    }
    
    
    function change_fp_show(flow_uuid, data_no, level, pos)
    {
    	var postdata = { 
	    			csrfmiddlewaretoken: csrfmiddlewaretoken,
	    			data_no	 : data_no,
	    			flow_level	 : level
	    	}
    	if (level == 1)
    	{
    		postdata['flow_uuid'] = flow_uuid;
	    }
	    else
	    {
	    	postdata['flow_uuid'] = flow_uuid.split('-')[0];
	    	postdata['flow_uid'] = flow_uuid.split('-')[1];
	    }
    	omflowJsonAjax(postdata, '{% url "loadFlowObjectAjax" %}', callback)
    	
		var flow_history_table = '';
    	function callback(data)
    	{
    		if (data.status == 200)
    		{
    			if (pos == 'next')
    			{ 
    				level_now = level_now + 1;
    				flow_map += '<a id="map_'+level_now+'" onclick="change_fp_show(\''+flow_uuid+'\','+data_no+','+level+',\'map_'+level_now+'\')">/'+data.result.flow_name+'</a>';
    				$('#modal_flow_browser .modal-title h4 small').html(flow_map);
    			}
    			else
    			{
    				$('#'+pos).nextAll().remove();
    				flow_map = $('#modal_flow_browser .modal-title h4 small').html();
    			}
    			$('#flow_history_table').DataTable().clear();
    			$('#flow_history_table').DataTable().destroy();
    			$('#flowcontent').empty();
    			$('#flow_history_table tbody').empty();
		      	flowcontent.load(data.result.flowobject);
		      	var flowobject = JSON.parse(data.result.flowobject)
		      	var count = data.result.inoutput.length;
		      	$.each(data.result.inoutput, function(index,value){
		      		var checkflow = '';
		      		if(value.stop_chart_type == 'subflow')
		      		{ 
		      			var thisflow_uuid = flow_uuid.split('-')
		      			checkflow = ' <button class="btn btn-xs btn-default" onclick="change_fp_show(\''+thisflow_uuid+'-'+value.subflow_uid+'\',\''+data_no+'\','+(level+1)+',\'next\')"><i class="fas fa-search"></i></button>'
		      		}
		      		else if (value.stop_chart_type == 'outflow' | value.stop_chart_type == 'inflow')
		      		{
		      			checkflow = ' <button class="btn btn-xs btn-default" onclick="change_fp_show(\''+value.outflow_uuid+'\',\''+value.outflow_data_no+'\',1,\'next\')"><i class="fas fa-search"></i></button>'
		      		}
		      		$('#flow_history_table tbody').append('<tr data-value="'+value.chart_id+'"><td>'+value.createtime.slice(0,-7)+'</td><td>'+value.stop_chart_text+'</td><td><button class="btn btn-xs btn-default" onclick="inoutput('+index+')">檢視</button>'+checkflow+'</td></tr>')
		      	});
		      	inoutputdata = data.result.inoutput;
		      	flow_history_table =  $('#flow_history_table').DataTable({"ordering": false, "info": false, "lengthChange": false, "paging": false,"searching": false,"language": __const_language__})
		      	$('#flow_history_table tbody').off('click').on( 'click', 'tr', function(){
		      		flowcontent.setFocus($(this).data('value'));
			    });
			    $('#modal_flow_browser').off('hidden.bs.modal').on('hidden.bs.modal', function(){
		    		flow_history_table.clear();
		    		flow_history_table.destroy();
		    	});
		    	$('#flow_history_table tbody tr:last').trigger('click');
		      	$('#modal_flow_browser').modal('show');
			}
			else
			{
				omflowAlert('red', data.message);
			}
    	}
    }
    
    
    function inoutput(data)
    {
    	var input_myCodeMirror = CodeMirror.fromTextArea(document.getElementById('input_text'), {
			lineNumbers: true,
			matchBrackets: true,
	        autoCloseBrackets: true,
	        mode: "application/ld+json",
	        lineWrapping: true,
			indentUnit: 4,
		});
		var output_myCodeMirror = CodeMirror.fromTextArea(document.getElementById('output_text'), {
			lineNumbers: true,
			matchBrackets: true,
	        autoCloseBrackets: true,
	        mode: "application/ld+json",
	        lineWrapping: true,
			indentUnit: 4,
		});
		input_myCodeMirror.setValue(JSON.stringify(inoutputdata[data].input_data, undefined, 2))
		output_myCodeMirror.setValue(JSON.stringify(inoutputdata[data].output_data, undefined, 2))
		$('#modal-inoutput').on('shown.bs.modal', function(){
			input_myCodeMirror.refresh();
			output_myCodeMirror.refresh();
		});
		$('#modal-inoutput').on('hidden.bs.modal', function(){
			input_myCodeMirror.toTextArea();
			output_myCodeMirror.toTextArea();
		});
    	$('#modal-inoutput').modal('show');
    }
    
    
    function history_browser()
    {	
    	var date = new Date();
		date.setDate(date.getDate() + 1);
		var omdata_history_select_time;
	    var omdata_history_table;
	    var omdata_history_data_tmp;
		var omdata_history_data_len;
		var omdata_history_data_page;
    	omdata_history_select_time = date.getFullYear() +'-'+('0'+(date.getMonth()+1)).substr(-2)+'-'+('0'+date.getDate()).substr(-2);
    	omdata_history_table = $('#omdata_history_table').DataTable({
    		"autoWidth"	: false,
			"order"		: [[ 0, "dsc" ]], 					//	default order column[1]
			"ordering"	: false,
			"serverSide": true,							//	serverside data loading
			"dom"		:"<<t>'row'<'col-sm-5'><'col-sm-7'p>>",
			"language"	: __const_language__,
			"ajax": {
           		"url": "{% url 'listOmDataHistoryAjax' %}",
            	"type": "POST",
            	"data":	function ( d ) {
					return $.extend( {}, d, {
				        csrfmiddlewaretoken: csrfmiddlewaretoken,
				        flow_uuid	: '{{flow_uuid}}',
				        data_no		: '{{data_no}}',
				        data_id		: '{{data_id}}',
					    createtime	: omdata_history_select_time,
					    "closed"	: [1,0],
					    manage		: 0
				    }); 
				},
				"dataSrc": function(data){
					a = dataCompare(data,omdata_history_data_tmp,omdata_history_data_len,omdata_history_data_page,omdata_history_table);
					omdata_history_data_tmp = a['data_tmp']
					omdata_history_data_len = a['data_len']
					omdata_history_data_page = a['data_page']
					data.data = a['data.data']
					return data.data;
				},
        	},
        	"columns":[	
				{"data": "error", "render": function(data)
					{
						if(data)
							{return '<div class="label label-danger">異常</div>'}
						else
							{return '<div class="label label-success">正常</div>'}		
					}
				},
				{"data": "update_user"},
				{"data": "createtime", "width": "150px", "render": function(data)
					{
						if (data)
							{return data.slice(0,-7)}
						else
							{return ''}
					}
				},
	 		],
	 		"rowCallback": function(row, data){
	 			$(row).attr('onclick', 'form_history_select(this, '+data.id+')');
	 		},
	 		"drawCallback": function(){
	 			$('#omdata_history_table tbody tr:eq(0)').trigger('click');
	 			$('#modal_omdata_history').modal('show');
	 			$('#modal_omdata_history').on('hidden.bs.modal', function () {
	 				omdata_history_table.destroy();
	 			})
	 		}
    	});
    }
    
    function form_history_select(thistr, data_id) {
		var postbody = {csrfmiddlewaretoken: '{{ csrf_token }}', flow_uuid: '{{ flow_uuid }}', data_id: data_id}
		omflowJsonAjax(postbody, '{% url "loadOmDataAjax"%}', callback);
		
		function callback(data)
		{
			if (data.status == 200)
			{
				$('#omdata_history_formcontent').empty();
				omdata_history_formcontent.event_group_list(load_group_list);
				omdata_history_formcontent.event_user_list(load_user_list);
				omdata_history_formcontent.load(JSON.stringify(data.result.formobject));
				omdata_history_formcontent.setData(data.result.formdata);
				$('#omdata_history_formcontent input').prop('readonly', true);
				$('#omdata_history_formcontent select').prop('disabled', true);
				$('#omdata_history_formcontent input[type="radio"]').prop('disabled', true);
				$('#omdata_history_formcontent input[type="checkbox"]').prop('disabled', true);
				$('#attach_box').remove();
				if (data.result.files.length != 0)
				{
					$('#modal_omdata_history > .modal-dialog > .modal-content > .modal-body').append('<div class="box-body" id="attach_box"><div class="col-md-12"><div class="box"><div class="box-body">'
						+'<ul class="mailbox-attachments clearfix" id="attach_upload"></ul>'
						+'</div></div></div></div>');
					$.each(data.result.files, function(index, item){
						var delete_mes = '';
			    		var file_href = 'href="/api/history-files/download/'+item.file+'"';
			    		if (item.delete)
						{
							delete_mes = '<br>({% trans "此附件已刪除" %})'
							file_href = '';
						}
						$('#attach_upload').append('<li name="'+item.file_name+'"><div class="mailbox-attachment-info">'
				        	+'<a '+file_href+' class="mailbox-attachment-name" title="'+item.file_name+'&#10;'
				        	+'上傳者: '+item.upload_user_id__nick_name+'&#10;'
				        	+'大小: '+omflowSizeUnit(item.size)+'&#10;'
				        	+'修改日期: '+item.createtime.replace(/T/g,' ').slice(0,-7)+'" style="word-break: break-all;overflow: hidden;display: -webkit-box;-webkit-box-orient: vertical;-webkit-line-clamp: 2;"><i class="fa fa-paperclip"></i>&nbsp;&nbsp;'+item.file_name+delete_mes+'</a>'
				            +'<span class="mailbox-attachment-size">'+item.upload_user_id__nick_name+'</span>'
				            +'<span class="mailbox-attachment-size">'+omflowSizeUnit(item.size)+'</span>'
				            +'<span class="mailbox-attachment-size">'+item.createtime.replace(/T/g,' ').slice(0,-7)+'</span>'
				      		+'</div></li>');
					});
				}
			}
			else
			{
				omflowAlert('red', data.message);
			}
		}
		
		$('#omdata_history_table tr').removeClass('selected');
		$(thistr).addClass('selected');
	}; 
    
    
    function relation_browser()
    {}
    
    
    function attachment_browser()
    {
    	var postdata = {csrfmiddlewaretoken: '{{ csrf_token }}', flow_uuid: '{{ flow_uuid }}', data_no: '{{data_no}}', data_id: '{{data_id}}'};
    	omflowJsonAjax(postdata, '{% url "listOmDataFilesAjax"%}', callback);
    	
    	function callback(data)
    	{
    		if (data.status == 200)
			{
	    		$('#attach_list').empty();
	    		$.each(data.result, function(index, value){
		    		var delete_mes = '';
		    		var file_href = 'href="/api/history-files/download/'+value.file+'"';
		    		if (value.delete)
					{
						delete_mes = '<br>({% trans "此附件已刪除" %})'
						file_href = '';
					}
	    			$('#attach_list').append(
						'<li name="'+value.file_name+'"><div class="mailbox-attachment-info">'+
			        	'<a '+file_href+' class="mailbox-attachment-name" title="'+value.file_name+'&#10;大小: '+omflowSizeUnit(value.size)+'&#10;修改日期: '+value.createtime.replace(/T/g,' ').slice(0,-4)+'" style="overflow: hidden;display: -webkit-box;-webkit-box-orient: vertical;-webkit-line-clamp: 1;"><i class="fa fa-paperclip"></i>&nbsp;&nbsp;'+value.file_name+delete_mes+'</a>'+
			            '<span class="mailbox-attachment-size">'+omflowSizeUnit(value.size)+'</span><span class="mailbox-attachment-size">'+value.createtime.replace(/T/g,' ').slice(0,-4)+'</span>'+
			      		'</div></li>'
			      	);
	    		});
	    	}
			else
			{
				omflowAlert('red', data.message);
			}
    	}
    	
    	$('#modal_attachment_browser').modal('show')
    }
    
    
    function attachment_search(searchkey)
    {
    	$.each($('#attach_list li'), function(index, value){
    		if ($(value).attr('name').indexOf(searchkey) >= 0)
    		{
    			$(value).show();
    		}
    		else
    		{
    			$(value).hide();
    		}
    	})
    
    }
    
    
    function remove_upload(th,item)
    {
    	
    	for (var i = 0; i < filesToUpload.length; ++i) {
            if (filesToUpload[i].id === item)
                filesToUpload.splice(i, 1);
        }
        $(th).closest('li').remove();
        if (filesToUpload.length != 0)
        	{check_disk();}
        else
        	{$('button[name="file_upload"]').hide();}
    }
    
    
    function check_disk()
    {
    	var postbody = { csrfmiddlewaretoken: '{{ csrf_token }}', file_size: fileTotalSize };
		omflowJsonAjax(postbody, '{% url "getDiskStatusAjax" %}', actions_upload)
		
		function actions_upload(data){
			if (data.status == 200)
			{
				if (data.result)
				{
					$('label[name="fileWarning"]').hide();
					$('button[name="file_upload"]').show();
				} 
				else
				{
					$('label[name="fileWarning"]').show();
					$('button[name="file_upload"]').hide();
				}
			}
			else
			{
				omflowAlert('red', data.message);
			}
		}
    }
    
    
    function file_upload()
    {
		var form_data = new FormData();
		var url = '{% url "uploadOmdataFilesAjax"%}';
		form_data.append("csrfmiddlewaretoken", '{{ csrf_token }}');
		form_data.append("flow_uuid", '{{ flow_uuid }}');
		form_data.append("data_no", '{{ data_no }}');
		form_data.append("data_id", '{{ data_id }}');
		for (var i = 0, len = filesToUpload.length; i < len; i++) {
            form_data.append("files", filesToUpload[i].file);
        }
    	$.ajax({
			url: url,
			type: 'post',
	        data: form_data,
	        cache:false,
	        processData: false,
	        contentType: false,
	        dataType: 'json',
	        xhr : function () {
	        	var myXhr = $.ajaxSettings.xhr();
	        	if(myXhr.upload)
	        	{
	        		$('label[name="uploadWarning"]').show();
	        		$('#attachment_input').hide();
	        		$('#modal_attachment_browser .progress-bar').parent().show();
	        		$('#attachment_input, .btn-file, button[name="file_upload"], button[name="remove_upload"]').attr('disabled', true);
			    	Swal.fire({
					  title: '檔案上傳中...',
					  toast: true,
					  position: 'bottom-start',
					  showConfirmButton: false,
					});
					Swal.showLoading();
	        		myXhr.upload.addEventListener('progress',progressHandle, false);
	        		return myXhr;
	        	}
	      	},
	        success: function (data) {
	        	if(data.status == 200)
	        	{
		            $('label[name="uploadWarning"]').hide();
		            $('button[name="file_upload"]').hide();
		            $('#attachment_input').show();
		            $('#modal_attachment_browser .progress-bar').parent().hide();
		            $('#modal_attachment_browser .progress-bar').css('width','0%').text('0%');
		            $('#attachment_input, .btn-file, button[name="file_upload"], button[name="remove_upload"]').attr('disabled', false);
		            $('#attach_upload').empty();
		            fileIdCounter = 0;
		            filesToUpload = [];
		            fileTotalSize = 0;
		            attachment_browser();
		            Swal.fire({
			      	  icon : 'success',
			      	  title: '檔案上傳成功',
			      	  toast: true,
				  	  position: 'bottom-start',
				  	  showConfirmButton: false,
			      	  timer: 2000,
		  		    });
		  		 }
		  		 else
		  		 {
		  		 	omflowAlert('red', data.messge);
		  		 }
	        },
	        error: function(req, status, err) {
				$('#modal_error').modal('show');
	        	console.log('Something went wrong', status, err);
	    	}
		});
		
		function progressHandle()
		{
			var value = (event.loaded / event.total * 100 | 0);
			var strProgress = value + "%";
		    $("#modal_attachment_browser .progress-bar").css({"width": strProgress});
		    $("#modal_attachment_browser .progress-bar").text(strProgress);
		}
    	
    }
    
    
    function worklog_browser()
    {}
    
    
    function load_group_list()
	{
		var grouplist=[];
		var postbody = {csrfmiddlewaretoken: "{{ csrf_token }}", 'functional_flag_%B': 'False', 'ad_flag_%B': ['0']};
		$.ajax({
			url	: '{% url 'listGroupAjax' %}',
			type: 'post',
	        data: postbody,
	        async:false,
	        dataType: 'json',
	        success: function (data) {
	            grouplist = data.result;
	        },
	        error: function(req, status, err) {
				$('#modal_error').modal('show');
	        	console.log('Something went wrong', status, err);
	    	}
		});
		return grouplist;
	}
    
    
	function load_user_list(group_id)
	{
		var userlist = []
		$.ajax({
			url: "{% url 'searchGroupUserAjax' %}",
			type: 'post',
			async:false,
			data: { csrfmiddlewaretoken: '{{ csrf_token }}' , searchkey: group_id},
			success: function (data) {
				userlist = data.result;
			},
			error: function(req, status, err) {
				$('#modal_error').modal('show');
	        	console.log('Something went wrong', status, err);
	    	}
		});
		return userlist;
	}
    
      
    function readform(data_id)
    {
    	var postdata = {csrfmiddlewaretoken: csrfmiddlewaretoken, flow_uuid: '{{flow_uuid}}', data_id: data_id};
    	omflowJsonAjax(postdata, '{% url "loadOmDataAjax"%}', readFormDesign_callback);
    	function readFormDesign_callback(data)
    	{	
    		if(data.status == 200)
    		{
	    		formcontent.init(false);
	    		formcontent.event_group_list(load_group_list);
				formcontent.event_user_list(load_user_list);
	    		formcontent.load(JSON.stringify(data.result.formobject));
	    		formcontent.setData(data.result.formdata);
	    		$.each(data.result.config, function(index, value){
	    			if (value)
	    			{$('#'+index).show()}
	    		})
	    		$('#modal_flow_browser .modal-title').html('<h4>'+data.result.flow_name+'<small></small></h4>');
	    		$('#modal_omdata_history .modal-title').html('<h4>'+data.result.flow_name+'</h4>');
		    	if(url.indexOf('/my-mission/page/myform/') >= 0)
		    	{	
		    		$('ol.breadcrumb').append('<li><a href="/my-mission/page/mission/">我的任務</a></li><li>'+data.result.flow_name+'</li>');
		    		$('.content-header h1').append(paddingLeft('{{data_no}}', 8)+'<small>'+data.result.flow_name+'</small>');
				}
		    	else if(url.indexOf('/flowmanage/page/myform/') >= 0)
		    	{	
					$('ol.breadcrumb').append('<li><a href="javascript:history.back();">'+data.result.flow_name+'</a></li><li>'+paddingLeft('{{data_no}}', 8)+'</li>');
	    			$('.content-header h1').append(paddingLeft('{{data_no}}', 8)+'<small>'+data.result.flow_name+'</small>')	    			
		    	}
		    	if(data.result.quick_action != null)
		    	{
			    	var action1 = '';
					var action2 = '';
					var quick_action = data.result.quick_action.split(',');
					if(quick_action[0].length != 0)
					{
									
						action1 = '<button type="button" class="btn btn-default" title="'+quick_action[0]+'" onclick="quick_action(\'action1\', \'{{flow_uuid}}\', \'{{data_id}}\')" style="margin:1px 0px;background-color: #3d9970;color: #fff;border-color: #32664f;border-bottom: 1px solid #2B5140;box-shadow: inset 0 -1px #416454"> '+quick_action[0]+'</button>';
					}
					if(quick_action[1].length != 0)
					{
						action2 = '<button type="button" class="btn btn-default" title="'+quick_action[1]+'" onclick="quick_action(\'action2\', \'{{flow_uuid}}\', \'{{data_id}}\')" style="margin:1px 0px;background-color: #d81b60;color: #fff;border-color: #cc7b99;border-bottom: 1px solid #886571;box-shadow: inset 0 -1px #682c42"> '+quick_action[1]+'</button>';
					}
					$('.content .box-header:first .pull-right').append(action1+' '+action2);
				}
			}
			else
			{omflowAlert('red', data.message)}
    	}
    }
    
    
    function updateOmdata()
    {
    	$('#formcontent .form-group').removeClass('has-warning');
		Swal.fire({
		  title: '處理中...',
		  toast: true,
		  position: 'bottom-start',
		  showConfirmButton: false,
		});
		Swal.showLoading() ;
		var formdata = formcontent.getData()
		if (formdata.checker.length == 0)
		{
			var postbody = {csrfmiddlewaretoken: csrfmiddlewaretoken, 
							flow_uuid: '{{flow_uuid}}',
							data_id	 : '{{data_id}}',
							action	 : 'update',
							formdata : JSON.stringify(formdata.values)}
			
			omflowJsonAjax(postbody, '{% url "editOmDataAjax"%}', actions)
		}
		else
		{
			formdata.checker.forEach(function(item){
				$('#formcontent_'+item).addClass('has-warning');
			})
			Swal.close();
			omflowAlert('blue', '缺少必填欄位');
		}
	}
	
	
	function quick_action(action, flow_uuid, data_id){
	 	var postbody = {csrfmiddlewaretoken: csrfmiddlewaretoken, 
								flow_uuid: flow_uuid,
								data_id	 : data_id,
								action	 : 'update',
								quick_action: action,
				}
		omflowJsonAjax(postbody, '{% url "editOmDataAjax"%}', actions)
 	}
	
	
	function actions(data)
	{
    	Swal.close();
		if(data.status == 200)
		{
			Swal.fire({
	      	  icon : 'success',
	      	  title: '成功',
	      	  toast: true,
		  	  position: 'bottom-start',
		  	  showConfirmButton: false,
	      	  timer: 2000,
  		    });
  		    LSide();
  		    if(url.indexOf('/my-mission/page/myform/') >= 0)
	    	{	
	    		window.location.href = '/my-mission/page/mission/';
	    	}
	    	else if(url.indexOf('/flowmanage/page/myform/') >= 0)
	    	{	
	    		window.history.back()
	    	}
		}
		else if (data.status == 404)
		{
			omflowAlert('yellow', data.message);
		}
		else if (data.status == 500)
		{
			Swal.fire({
	      	  icon : 'info',
	      	  title: data.message,
	      	  toast: true,
		  	  position: 'bottom-start',
		  	  showConfirmButton: false,
	      	  timer: 10000,
  		    });
  		    $('#modal-create_ticket').modal('show')
		}
		else if (data.status == 403)
		{
			omflowAlert('red', data.message);
		}
    }
    </script>
{% endblock %}